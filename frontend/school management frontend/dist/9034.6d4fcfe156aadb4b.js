"use strict";(self.webpackChunkmantis_free_version=self.webpackChunkmantis_free_version||[]).push([[9034],{965:(E,F,u)=>{u.d(F,{y:()=>h});var c=u(2525),m=u(4438),e=u(1626);let h=(()=>{class p{constructor(s){this.http=s,this.baseUrl=`${c.c.apiUrl}/api/academicyear`}createAcademicYear(s){return this.http.post(`${this.baseUrl}/create`,s)}editAcademicYear(s){return this.http.put(`${this.baseUrl}/edit`,s)}getActiveAcademicYear(s){return this.http.get(`${this.baseUrl}/active/${s}`)}getAllAcademicYears(s){return this.http.get(`${this.baseUrl}/${s}`)}activateAcademicYear(s,l){return this.http.post(`${this.baseUrl}/activate/${l}`,{academicYearId:s})}setActiveAcademicYear(s,l){return this.http.post(`${this.baseUrl}/set`,{schoolId:s,academicYearId:l})}getNextAcademicYear(s,l){return this.http.get(`${this.baseUrl}/next/${s}?schoolId=${l}`)}static{this.\u0275fac=function(l){return new(l||p)(m.KVO(e.Qq))}}static{this.\u0275prov=m.jDH({token:p,factory:p.\u0275fac,providedIn:"root"})}}return p})()},3891:(E,F,u)=>{u.d(F,{e:()=>h});var c=u(1626),m=u(2525),e=u(4438);let h=(()=>{class p{constructor(s){this.http=s,this.apiUrl=m.c.apiUrl}getClassesBySchool(s){return this.http.get(`${this.apiUrl}/api/class-subject-management/classes/${s}`)}getStudentsByClass(s,l){const _=`${this.apiUrl}/api/students/get-student-by-class/${s}`,f=(new c.Nl).set("academicYearId",l);return this.http.get(_,{params:f})}assignRollNumbers(s){return this.http.post(`${this.apiUrl}/api/students/assign-roll-numbers?classId=${s}`,{})}assignRollNumbersAlphabetically(s){return this.http.post(`${this.apiUrl}/api/students/assign-roll-numbers-alphabetically?classId=${s}`,{})}assignRollNumberToStudent(s,l){return this.http.put(`${this.apiUrl}/api/students/${s}/assign-roll-number`,{rollNo:l})}createClass(s){return this.http.post(`${this.apiUrl}/api/class-subject-management/classes`,s)}deleteAssignment(s){return this.http.delete(`${this.apiUrl}/api/class-subject-management/assign-subject`,{body:s})}createSubject(s){return this.http.post(`${this.apiUrl}/api/class-subject-management/subject`,s)}getSubjects(s){return this.http.get(`${this.apiUrl}/api/class-subject-management/subjects/${s}`)}getTeachers(s){return this.http.get(`${this.apiUrl}/api/class-subject-management/teachers/by-school/${s}`)}getCombinedAssignments(s,l){const _=(new c.Nl).set("academicYearId",l);return this.http.get(`${this.apiUrl}/api/class-subject-management/assignments/${s}`,{params:_})}assignSubjectToClass(s,l,_,f){return this.http.post(`${this.apiUrl}/api/class-subject-management/assign-subject`,{classId:s,subjectId:l,teacherId:_,academicYearId:f})}updateAssignment(s){return this.http.put(`${this.apiUrl}/api/class-subject-management/assign-subject`,s)}getAssignmentsByTeacher(s,l,_){let f=(new c.Nl).set("academicYearId",l);return _&&(f=f.set("date",_)),this.http.get(`${this.apiUrl}/api/class-subject-management/assignments/teacher/${s}`,{params:f})}updateAttendanceTeachers(s,l,_){return this.http.put(`${this.apiUrl}/api/class-subject-management/update-attendance-teachers`,{classId:s,attendanceTeacher:l,substituteAttendanceTeachers:_})}getTeacherAttendanceClasses(){return this.http.get(`${this.apiUrl}/api/class-subject-management/teacher-classes`)}static{this.\u0275fac=function(l){return new(l||p)(e.KVO(c.Qq))}}static{this.\u0275prov=e.jDH({token:p,factory:p.\u0275fac,providedIn:"root"})}}return p})()},9034:(E,F,u)=>{u.r(F),u.d(F,{FeeStructureComponent:()=>xe});var c=u(9417),m=u(177),e=u(4438),h=u(2329),p=u(6561),y=u(5794),s=u(3891),l=u(965),_=u(3338),f=u(8652);const M=["feeStructureModal"],j=["confirmDeleteModal"];function O(n,o){if(1&n&&(e.j41(0,"li",26),e.EFF(1),e.k0s()),2&n){const t=o.$implicit,i=e.XpG(4);e.R7$(),e.Lme(" ",i.getRouteName(t.routeId),": \u20b9",t.amount," ")}}function S(n,o){if(1&n&&(e.j41(0,"div",23)(1,"span"),e.EFF(2,"Routes:"),e.k0s(),e.j41(3,"ul",24),e.DNE(4,O,2,2,"li",25),e.k0s()()),2&n){const t=e.XpG().$implicit;e.R7$(4),e.Y8G("ngForOf",t.routeOptions)}}function P(n,o){if(1&n&&(e.j41(0,"span",28),e.EFF(1),e.k0s()),2&n){const t=o.$implicit,i=e.XpG(4);e.R7$(),e.SpI(" ",i.monthNames[t-1]," ")}}function $(n,o){if(1&n&&(e.j41(0,"div",23)(1,"span"),e.EFF(2,"Months:"),e.k0s(),e.j41(3,"div"),e.DNE(4,P,2,1,"span",27),e.k0s()()),2&n){const t=e.XpG().$implicit;e.R7$(4),e.Y8G("ngForOf",t.specificMonths)}}function x(n,o){if(1&n&&(e.j41(0,"li",21)(1,"strong"),e.EFF(2),e.nI1(3,"titlecase"),e.k0s(),e.EFF(4),e.DNE(5,S,5,1,"div",22)(6,$,5,1,"div",22),e.k0s()),2&n){const t=o.$implicit;e.R7$(2),e.SpI("",e.bMT(3,6,t.name),":"),e.R7$(2),e.E5c(" \u20b9",t.amount," (",t.type,", ",t.frequency,") "),e.R7$(),e.Y8G("ngIf","transportFee"===t.name&&(null==t.routeOptions?null:t.routeOptions.length)),e.R7$(),e.Y8G("ngIf","Specific Months"===t.frequency&&(null==t.specificMonths?null:t.specificMonths.length))}}function R(n,o){if(1&n&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&n){const t=e.XpG(2).$implicit;e.R7$(),e.SpI(" \u20b9",t.lateFeeConfig.dailyRate," per day ")}}function I(n,o){if(1&n&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&n){const t=e.XpG(2).$implicit;e.R7$(),e.SpI(" \u20b9",t.lateFeeConfig.fixedAmount," fixed ")}}function T(n,o){if(1&n&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&n){const t=e.XpG(2).$implicit;e.R7$(),e.SpI(" ",t.lateFeeConfig.percentageRate,"% ")}}function G(n,o){if(1&n&&(e.j41(0,"div",29)(1,"span"),e.EFF(2),e.nI1(3,"titlecase"),e.k0s(),e.nrm(4,"br"),e.j41(5,"span"),e.EFF(6,"Rate: "),e.DNE(7,R,2,1,"span",30)(8,I,2,1,"span",30)(9,T,2,1,"span",30),e.k0s(),e.nrm(10,"br"),e.j41(11,"span"),e.EFF(12),e.k0s(),e.nrm(13,"br"),e.j41(14,"span"),e.EFF(15),e.k0s()()),2&n){const t=e.XpG().$implicit;e.R7$(2),e.SpI("Type: ",e.bMT(3,6,t.lateFeeConfig.calculationType),""),e.R7$(5),e.Y8G("ngIf","daily"===t.lateFeeConfig.calculationType),e.R7$(),e.Y8G("ngIf","fixed"===t.lateFeeConfig.calculationType),e.R7$(),e.Y8G("ngIf","percentage"===t.lateFeeConfig.calculationType),e.R7$(3),e.SpI("Max: \u20b9",t.lateFeeConfig.maxLateFee,""),e.R7$(3),e.SpI("Grace: ",t.lateFeeConfig.gracePeriodDays," days")}}function N(n,o){1&n&&(e.j41(0,"span",31),e.EFF(1,"Disabled"),e.k0s())}function D(n,o){if(1&n&&(e.j41(0,"li",29),e.EFF(1),e.k0s()),2&n){const t=o.$implicit;e.R7$(),e.E5c(" ",t.name,": ",t.amount,"","Percentage"===t.type?"%":"\u20b9"," ")}}function Y(n,o){1&n&&(e.j41(0,"li",32),e.EFF(1,"No discounts"),e.k0s())}function A(n,o){if(1&n){const t=e.RV6();e.j41(0,"tr")(1,"td"),e.EFF(2),e.k0s(),e.j41(3,"td"),e.EFF(4),e.k0s(),e.j41(5,"td"),e.EFF(6),e.k0s(),e.j41(7,"td")(8,"ul",13),e.DNE(9,x,7,8,"li",14),e.k0s()(),e.j41(10,"td"),e.DNE(11,G,16,8,"div",15)(12,N,2,0,"ng-template",null,3,e.C5r),e.k0s(),e.j41(14,"td")(15,"ul",16),e.DNE(16,D,2,3,"li",17)(17,Y,2,0,"li",18),e.k0s()(),e.j41(18,"td")(19,"span",19),e.bIt("click",function(){const r=e.eBV(t).$implicit,a=e.XpG();return e.Njj(a.openEditModal(r._id))}),e.EFF(20,"edit"),e.k0s(),e.j41(21,"span",20),e.bIt("click",function(){const r=e.eBV(t).$implicit,a=e.XpG();return e.Njj(a.confirmDelete(r._id))}),e.EFF(22,"delete"),e.k0s()()()}if(2&n){const t=o.$implicit,i=o.index,r=e.sdS(13);e.R7$(2),e.JRh(i+1),e.R7$(2),e.JRh((null==t.classId?null:t.classId.name)||"N/A"),e.R7$(2),e.JRh((null==t.academicYearId?null:t.academicYearId.name)||"N/A"),e.R7$(3),e.Y8G("ngForOf",t.fees),e.R7$(2),e.Y8G("ngIf",null==t.lateFeeConfig?null:t.lateFeeConfig.isEnabled)("ngIfElse",r),e.R7$(5),e.Y8G("ngForOf",t.discounts),e.R7$(),e.Y8G("ngIf",!t.discounts.length)}}function U(n,o){1&n&&(e.j41(0,"div",34),e.nrm(1,"i",35),e.EFF(2,' No fee structures found. Click "Create Fee Structure" to add one. '),e.k0s())}function B(n,o){1&n&&(e.j41(0,"div",34),e.nrm(1,"i",36),e.EFF(2," Loading fee structures... "),e.k0s())}function X(n,o){if(1&n&&e.DNE(0,U,3,0,"div",33)(1,B,3,0,"div",33),2&n){const t=e.XpG();e.Y8G("ngIf",0===t.feeStructures.length&&!t.loading),e.R7$(),e.Y8G("ngIf",t.loading)}}function q(n,o){if(1&n&&(e.j41(0,"option",61),e.EFF(1),e.k0s()),2&n){const t=o.$implicit;e.Y8G("value",t._id),e.R7$(),e.JRh(t.name)}}function V(n,o){1&n&&(e.j41(0,"div",62),e.EFF(1," Please select a class "),e.k0s())}function w(n,o){if(1&n&&(e.j41(0,"option",61),e.EFF(1),e.k0s()),2&n){const t=o.$implicit;e.Y8G("value",t._id),e.R7$(),e.JRh(t.name)}}function L(n,o){1&n&&(e.j41(0,"div",62),e.EFF(1," Please select an academic year "),e.k0s())}function K(n,o){if(1&n&&(e.j41(0,"div",51)(1,"div",52)(2,"div",53)(3,"label",54),e.EFF(4,"Class "),e.j41(5,"span",55),e.EFF(6,"*"),e.k0s()(),e.j41(7,"select",56)(8,"option",57),e.EFF(9,"Select Class"),e.k0s(),e.DNE(10,q,2,2,"option",58),e.k0s(),e.DNE(11,V,2,0,"div",59),e.k0s(),e.j41(12,"div",53)(13,"label",54),e.EFF(14,"Academic Year "),e.j41(15,"span",55),e.EFF(16,"*"),e.k0s()(),e.j41(17,"select",60)(18,"option",57),e.EFF(19,"Select Academic Year"),e.k0s(),e.DNE(20,w,2,2,"option",58),e.k0s(),e.DNE(21,L,2,0,"div",59),e.k0s()()()),2&n){let t,i;const r=e.XpG(2);e.R7$(10),e.Y8G("ngForOf",r.classList),e.R7$(),e.Y8G("ngIf",(null==(t=r.feeForm.get("classId"))?null:t.invalid)&&(null==(t=r.feeForm.get("classId"))?null:t.touched)),e.R7$(9),e.Y8G("ngForOf",r.academicYears),e.R7$(),e.Y8G("ngIf",(null==(i=r.feeForm.get("academicYearId"))?null:i.invalid)&&(null==(i=r.feeForm.get("academicYearId"))?null:i.touched))}}function W(n,o){if(1&n&&(e.j41(0,"option",61),e.EFF(1),e.k0s()),2&n){const t=o.$implicit;e.Y8G("value",t),e.R7$(),e.JRh(t)}}function J(n,o){1&n&&(e.j41(0,"div",62),e.EFF(1," Please select a frequency "),e.k0s())}function z(n,o){if(1&n&&(e.j41(0,"div",51)(1,"div",63)(2,"label",54),e.EFF(3,"Frequency "),e.j41(4,"span",55),e.EFF(5,"*"),e.k0s()(),e.j41(6,"select",64),e.DNE(7,W,2,2,"option",58),e.k0s(),e.DNE(8,J,2,0,"div",59),e.k0s()()),2&n){let t;const i=e.XpG(2);e.R7$(7),e.Y8G("ngForOf",i.frequencies),e.R7$(),e.Y8G("ngIf",(null==(t=i.feeForm.get("frequency"))?null:t.invalid)&&(null==(t=i.feeForm.get("frequency"))?null:t.touched))}}function Q(n,o){1&n&&(e.j41(0,"div",62),e.EFF(1," Enter a valid amount "),e.k0s())}function H(n,o){if(1&n&&(e.j41(0,"option",61),e.EFF(1),e.k0s()),2&n){const t=o.$implicit;e.Y8G("value",t),e.R7$(),e.JRh(t)}}function Z(n,o){if(1&n){const t=e.RV6();e.j41(0,"button",95),e.bIt("click",function(){const r=e.eBV(t).$implicit,a=e.XpG(2).index,d=e.XpG(3);return e.Njj(d.toggleSpecificMonths(a,r))}),e.EFF(1),e.k0s()}if(2&n){const t=o.$implicit,i=e.XpG(2).index,r=e.XpG(3);e.AVh("btn-primary",r.isMonthSelected(i,t))("btn-outline-primary",!r.isMonthSelected(i,t)),e.R7$(),e.SpI(" ",r.monthNames[t-1]," ")}}function ee(n,o){if(1&n&&(e.j41(0,"div",92)(1,"label",54),e.EFF(2,"Select Months"),e.k0s(),e.j41(3,"div",93),e.DNE(4,Z,2,5,"button",94),e.k0s()()),2&n){const t=e.XpG(4);e.R7$(4),e.Y8G("ngForOf",t.months)}}function te(n,o){if(1&n&&(e.j41(0,"option",61),e.EFF(1),e.k0s()),2&n){const t=o.$implicit;e.Y8G("value",t._id),e.R7$(),e.Lme(" ",t.name," (\u20b9",t.feeAmount,") ")}}function ne(n,o){if(1&n){const t=e.RV6();e.j41(0,"div",99)(1,"div",100)(2,"label",54),e.EFF(3,"Route"),e.k0s(),e.j41(4,"select",101),e.bIt("change",function(r){const a=e.eBV(t).index,d=e.XpG(2).index,g=e.XpG(3);return e.Njj(g.updateRouteAmount(d,a,r))}),e.j41(5,"option",57),e.EFF(6,"Select Route"),e.k0s(),e.DNE(7,te,2,3,"option",58),e.k0s()(),e.j41(8,"div")(9,"label",54),e.EFF(10,"Amount"),e.k0s(),e.j41(11,"div",87)(12,"span",88),e.EFF(13,"\u20b9"),e.k0s(),e.nrm(14,"input",89),e.k0s()(),e.j41(15,"div")(16,"button",102),e.bIt("click",function(){const r=e.eBV(t).index,a=e.XpG(2).index,d=e.XpG(3);return e.Njj(d.removeRouteOption(a,r))}),e.nrm(17,"i",103),e.k0s()()()}if(2&n){const t=o.index,i=e.XpG(5);e.Y8G("formGroupName",t),e.R7$(7),e.Y8G("ngForOf",i.routes)}}function ie(n,o){if(1&n){const t=e.RV6();e.j41(0,"div",96)(1,"h6",21),e.EFF(2,"Route Options"),e.k0s(),e.j41(3,"div",97),e.DNE(4,ne,18,2,"div",98),e.k0s(),e.j41(5,"button",79),e.bIt("click",function(){e.eBV(t);const r=e.XpG().index,a=e.XpG(3);return e.Njj(a.addRouteOption(r))}),e.nrm(6,"i",68),e.EFF(7," Add Route "),e.k0s()()}if(2&n){const t=e.XpG().index,i=e.XpG(3);e.R7$(4),e.Y8G("ngForOf",i.getRouteOptions(t).controls)}}function se(n,o){if(1&n&&(e.j41(0,"div",80)(1,"div",81)(2,"div",82)(3,"label",54),e.EFF(4,"Fee Name"),e.k0s(),e.nrm(5,"input",83),e.k0s(),e.j41(6,"div",84)(7,"label",54),e.EFF(8,"Type"),e.k0s(),e.nrm(9,"input",85),e.k0s(),e.j41(10,"div",86)(11,"label",54),e.EFF(12,"Amount "),e.j41(13,"span",55),e.EFF(14,"*"),e.k0s()(),e.j41(15,"div",87)(16,"span",88),e.EFF(17,"\u20b9"),e.k0s(),e.nrm(18,"input",89),e.k0s(),e.DNE(19,Q,2,0,"div",59),e.k0s(),e.j41(20,"div",86)(21,"label",54),e.EFF(22,"Frequency "),e.j41(23,"span",55),e.EFF(24,"*"),e.k0s()(),e.j41(25,"select",64),e.DNE(26,H,2,2,"option",58),e.k0s()()(),e.DNE(27,ee,5,1,"div",90)(28,ie,8,1,"div",91),e.k0s()),2&n){let t;const i=o.$implicit,r=o.index,a=e.XpG(3);e.Y8G("formGroupName",r),e.R7$(5),e.Y8G("readonly",r<a.initialFeeCount),e.R7$(4),e.Y8G("readonly",r<a.initialFeeCount),e.R7$(10),e.Y8G("ngIf",(null==(t=i.get("amount"))?null:t.invalid)&&(null==(t=i.get("amount"))?null:t.touched)),e.R7$(7),e.Y8G("ngForOf",a.frequencies),e.R7$(),e.Y8G("ngIf","Specific Months"===i.value.frequency),e.R7$(),e.Y8G("ngIf","transportFee"===i.value.name&&a.routes.length)}}function re(n,o){1&n&&(e.j41(0,"div",53)(1,"label",54),e.EFF(2,"Daily Rate"),e.k0s(),e.j41(3,"div",87)(4,"span",88),e.EFF(5,"\u20b9"),e.k0s(),e.nrm(6,"input",111),e.k0s()())}function oe(n,o){1&n&&(e.j41(0,"div",53)(1,"label",54),e.EFF(2,"Fixed Amount"),e.k0s(),e.j41(3,"div",87)(4,"span",88),e.EFF(5,"\u20b9"),e.k0s(),e.nrm(6,"input",112),e.k0s()())}function ae(n,o){1&n&&(e.j41(0,"div",53)(1,"label",54),e.EFF(2,"Percentage Rate"),e.k0s(),e.j41(3,"div",87),e.nrm(4,"input",113),e.j41(5,"span",88),e.EFF(6,"%"),e.k0s()()())}function ce(n,o){if(1&n&&(e.j41(0,"div",52)(1,"div",53)(2,"label",54),e.EFF(3,"Type"),e.k0s(),e.j41(4,"select",104)(5,"option",105),e.EFF(6,"Daily Rate"),e.k0s(),e.j41(7,"option",106),e.EFF(8,"Fixed Amount"),e.k0s(),e.j41(9,"option",107),e.EFF(10,"Percentage"),e.k0s()()(),e.j41(11,"div",53)(12,"label",54),e.EFF(13,"Grace Period (days)"),e.k0s(),e.nrm(14,"input",108),e.k0s(),e.DNE(15,re,7,0,"div",109)(16,oe,7,0,"div",109)(17,ae,7,0,"div",109),e.j41(18,"div",53)(19,"label",54),e.EFF(20,"Max Late Fee"),e.k0s(),e.j41(21,"div",87)(22,"span",88),e.EFF(23,"\u20b9"),e.k0s(),e.nrm(24,"input",110),e.k0s()()()),2&n){let t,i,r;const a=e.XpG(3);e.R7$(15),e.Y8G("ngIf","daily"===(null==(t=a.feeForm.get("lateFeeConfig.calculationType"))?null:t.value)),e.R7$(),e.Y8G("ngIf","fixed"===(null==(i=a.feeForm.get("lateFeeConfig.calculationType"))?null:i.value)),e.R7$(),e.Y8G("ngIf","percentage"===(null==(r=a.feeForm.get("lateFeeConfig.calculationType"))?null:r.value))}}function le(n,o){1&n&&(e.j41(0,"span",88),e.EFF(1,"%"),e.k0s())}function ue(n,o){1&n&&(e.j41(0,"span",88),e.EFF(1,"\u20b9"),e.k0s())}function de(n,o){if(1&n){const t=e.RV6();e.j41(0,"div",114)(1,"div",100)(2,"label",54),e.EFF(3,"Name"),e.k0s(),e.nrm(4,"input",115),e.k0s(),e.j41(5,"div")(6,"label",54),e.EFF(7,"Type"),e.k0s(),e.j41(8,"select",116)(9,"option",117),e.EFF(10,"Percentage"),e.k0s(),e.j41(11,"option",118),e.EFF(12,"Fixed"),e.k0s()()(),e.j41(13,"div")(14,"label",54),e.EFF(15,"Amount"),e.k0s(),e.j41(16,"div",87),e.DNE(17,le,2,0,"span",119)(18,ue,2,0,"span",119),e.nrm(19,"input",89),e.k0s()(),e.j41(20,"div")(21,"button",102),e.bIt("click",function(){const r=e.eBV(t).index,a=e.XpG(3);return e.Njj(a.removeDiscount(r))}),e.nrm(22,"i",103),e.k0s()()()}if(2&n){const t=o.$implicit;e.Y8G("formGroupName",o.index),e.R7$(17),e.Y8G("ngIf","Percentage"===t.value.type),e.R7$(),e.Y8G("ngIf","Fixed"===t.value.type)}}function pe(n,o){if(1&n){const t=e.RV6();e.j41(0,"div",51)(1,"div",65),e.DNE(2,se,29,7,"div",66),e.j41(3,"button",67),e.bIt("click",function(){e.eBV(t);const r=e.XpG(2);return e.Njj(r.addCustomFee())}),e.nrm(4,"i",68),e.EFF(5," Add Fee "),e.k0s()(),e.j41(6,"div",69)(7,"h6",70),e.EFF(8,"Late Fee Configuration"),e.k0s(),e.j41(9,"div",71)(10,"div",72),e.nrm(11,"input",73),e.j41(12,"label",74),e.EFF(13,"Enable Late Fees"),e.k0s()(),e.DNE(14,ce,25,3,"div",75),e.k0s()(),e.j41(15,"div",76)(16,"h6",70),e.EFF(17,"Discounts"),e.k0s(),e.j41(18,"div",77),e.DNE(19,de,23,3,"div",78),e.j41(20,"button",79),e.bIt("click",function(){e.eBV(t);const r=e.XpG(2);return e.Njj(r.addDiscount())}),e.nrm(21,"i",68),e.EFF(22," Add Discount "),e.k0s()()()()}if(2&n){let t;const i=e.XpG(2);e.R7$(2),e.Y8G("ngForOf",i.fees.controls),e.R7$(12),e.Y8G("ngIf",null==(t=i.feeForm.get("lateFeeConfig.isEnabled"))?null:t.value),e.R7$(5),e.Y8G("ngForOf",i.discounts.controls)}}function _e(n,o){if(1&n&&(e.j41(0,"li",29),e.EFF(1),e.k0s()),2&n){const t=o.$implicit,i=e.XpG(5);e.R7$(),e.Lme(" ",i.getRouteName(t.routeId),": \u20b9",t.amount," ")}}function me(n,o){if(1&n&&(e.j41(0,"div")(1,"small",130),e.EFF(2,"Routes:"),e.k0s(),e.j41(3,"ul",16),e.DNE(4,_e,2,2,"li",17),e.k0s()()),2&n){const t=e.XpG().$implicit;e.R7$(4),e.Y8G("ngForOf",t.routeOptions)}}function fe(n,o){if(1&n&&(e.j41(0,"span",28),e.EFF(1),e.k0s()),2&n){const t=o.$implicit,i=e.XpG(5);e.R7$(),e.SpI(" ",i.monthNames[t-1]," ")}}function ge(n,o){if(1&n&&(e.j41(0,"div")(1,"small",130),e.EFF(2,"Months:"),e.k0s(),e.j41(3,"div"),e.DNE(4,fe,2,1,"span",27),e.k0s()()),2&n){const t=e.XpG().$implicit;e.R7$(4),e.Y8G("ngForOf",t.specificMonths)}}function Fe(n,o){if(1&n&&(e.j41(0,"tr")(1,"td"),e.EFF(2),e.nI1(3,"titlecase"),e.k0s(),e.j41(4,"td"),e.EFF(5),e.k0s(),e.j41(6,"td"),e.EFF(7),e.k0s(),e.j41(8,"td"),e.EFF(9),e.k0s(),e.j41(10,"td"),e.DNE(11,me,5,1,"div",30)(12,ge,5,1,"div",30),e.k0s()()),2&n){const t=o.$implicit;e.R7$(2),e.JRh(e.bMT(3,6,t.name)),e.R7$(3),e.JRh(t.type),e.R7$(2),e.SpI("\u20b9",t.amount,""),e.R7$(2),e.JRh(t.frequency),e.R7$(2),e.Y8G("ngIf","transportFee"===t.name&&(null==t.routeOptions?null:t.routeOptions.length)),e.R7$(),e.Y8G("ngIf","Specific Months"===t.frequency&&(null==t.specificMonths?null:t.specificMonths.length))}}function he(n,o){if(1&n&&(e.j41(0,"p")(1,"strong"),e.EFF(2,"Daily Rate:"),e.k0s(),e.EFF(3),e.k0s()),2&n){const t=e.XpG(4);e.R7$(3),e.SpI(" \u20b9",t.feeForm.value.lateFeeConfig.dailyRate," ")}}function ve(n,o){if(1&n&&(e.j41(0,"p")(1,"strong"),e.EFF(2,"Fixed Amount:"),e.k0s(),e.EFF(3),e.k0s()),2&n){const t=e.XpG(4);e.R7$(3),e.SpI(" \u20b9",t.feeForm.value.lateFeeConfig.fixedAmount," ")}}function be(n,o){if(1&n&&(e.j41(0,"p")(1,"strong"),e.EFF(2,"Percentage:"),e.k0s(),e.EFF(3),e.k0s()),2&n){const t=e.XpG(4);e.R7$(3),e.SpI(" ",t.feeForm.value.lateFeeConfig.percentageRate,"% ")}}function Ce(n,o){if(1&n&&(e.j41(0,"div")(1,"div",125)(2,"div",82)(3,"p")(4,"strong"),e.EFF(5,"Type:"),e.k0s(),e.EFF(6),e.nI1(7,"titlecase"),e.k0s()(),e.j41(8,"div",82),e.DNE(9,he,4,1,"p",30)(10,ve,4,1,"p",30)(11,be,4,1,"p",30),e.k0s(),e.j41(12,"div",82)(13,"p")(14,"strong"),e.EFF(15,"Max Late Fee:"),e.k0s(),e.EFF(16),e.k0s()(),e.j41(17,"div",82)(18,"p")(19,"strong"),e.EFF(20,"Grace Period:"),e.k0s(),e.EFF(21),e.k0s()()()()),2&n){const t=e.XpG(3);e.R7$(6),e.SpI(" ",e.bMT(7,6,t.feeForm.value.lateFeeConfig.calculationType),""),e.R7$(3),e.Y8G("ngIf","daily"===t.feeForm.value.lateFeeConfig.calculationType),e.R7$(),e.Y8G("ngIf","fixed"===t.feeForm.value.lateFeeConfig.calculationType),e.R7$(),e.Y8G("ngIf","percentage"===t.feeForm.value.lateFeeConfig.calculationType),e.R7$(5),e.SpI(" \u20b9",t.feeForm.value.lateFeeConfig.maxLateFee,""),e.R7$(5),e.SpI(" ",t.feeForm.value.lateFeeConfig.gracePeriodDays," days")}}function Ee(n,o){1&n&&(e.j41(0,"p",131),e.EFF(1,"Late fees are disabled for this fee structure"),e.k0s())}function ke(n,o){if(1&n&&(e.j41(0,"tr")(1,"td"),e.EFF(2),e.k0s(),e.j41(3,"td"),e.EFF(4),e.k0s(),e.j41(5,"td"),e.EFF(6),e.k0s()()),2&n){const t=o.$implicit;e.R7$(2),e.JRh(t.name),e.R7$(2),e.JRh(t.type),e.R7$(2),e.Lme("",t.amount,"","Percentage"===t.type?"%":"\u20b9","")}}function ye(n,o){if(1&n&&(e.j41(0,"div",121)(1,"div",122)(2,"h6",123),e.EFF(3,"Discounts"),e.k0s()(),e.j41(4,"div",124)(5,"div",126)(6,"table",127)(7,"thead")(8,"tr")(9,"th"),e.EFF(10,"Name"),e.k0s(),e.j41(11,"th"),e.EFF(12,"Type"),e.k0s(),e.j41(13,"th"),e.EFF(14,"Amount"),e.k0s()()(),e.j41(15,"tbody"),e.DNE(16,ke,7,4,"tr",12),e.k0s()()()()()),2&n){const t=e.XpG(3);e.R7$(16),e.Y8G("ngForOf",t.feeForm.value.discounts)}}function Me(n,o){if(1&n&&(e.j41(0,"div",51)(1,"h5",120),e.EFF(2,"Review Fee Structure"),e.k0s(),e.j41(3,"div",121)(4,"div",122)(5,"h6",123),e.EFF(6,"Basic Information"),e.k0s()(),e.j41(7,"div",124)(8,"div",125)(9,"div",53)(10,"p")(11,"strong"),e.EFF(12,"Class:"),e.k0s(),e.EFF(13),e.k0s()(),e.j41(14,"div",53)(15,"p")(16,"strong"),e.EFF(17,"Academic Year:"),e.k0s(),e.EFF(18),e.k0s()(),e.j41(19,"div",53)(20,"p")(21,"strong"),e.EFF(22,"Frequency:"),e.k0s(),e.EFF(23),e.k0s()()()()(),e.j41(24,"div",121)(25,"div",122)(26,"h6",123),e.EFF(27,"Fees"),e.k0s()(),e.j41(28,"div",124)(29,"div",126)(30,"table",127)(31,"thead")(32,"tr")(33,"th"),e.EFF(34,"Name"),e.k0s(),e.j41(35,"th"),e.EFF(36,"Type"),e.k0s(),e.j41(37,"th"),e.EFF(38,"Amount"),e.k0s(),e.j41(39,"th"),e.EFF(40,"Frequency"),e.k0s(),e.j41(41,"th"),e.EFF(42,"Details"),e.k0s()()(),e.j41(43,"tbody"),e.DNE(44,Fe,13,8,"tr",12),e.k0s()()()()(),e.j41(45,"div",121)(46,"div",122)(47,"h6",123),e.EFF(48,"Late Fee Configuration"),e.k0s()(),e.j41(49,"div",124),e.DNE(50,Ce,22,8,"div",128)(51,Ee,2,0,"ng-template",null,3,e.C5r),e.k0s()(),e.DNE(53,ye,17,1,"div",129),e.k0s()),2&n){const t=e.sdS(52),i=e.XpG(2);e.R7$(13),e.SpI(" ",i.getClassName(i.feeForm.value.classId),""),e.R7$(5),e.SpI(" ",i.getAcademicYearName(i.feeForm.value.academicYearId),""),e.R7$(5),e.SpI(" ",i.feeForm.value.frequency,""),e.R7$(21),e.Y8G("ngForOf",i.feeForm.value.fees),e.R7$(6),e.Y8G("ngIf",i.feeForm.value.lateFeeConfig.isEnabled)("ngIfElse",t),e.R7$(3),e.Y8G("ngIf",i.feeForm.value.discounts.length)}}function je(n,o){if(1&n&&(e.j41(0,"div",51)(1,"div",132),e.nrm(2,"i",35),e.EFF(3),e.k0s()()),2&n){const t=e.XpG(2);e.R7$(3),e.SpI(' Please review all details carefully. Click "',t.isEditMode?"Update":"Create",' Fee Structure" to save or go back to make changes. ')}}function Oe(n,o){if(1&n){const t=e.RV6();e.j41(0,"button",133),e.bIt("click",function(){e.eBV(t);const r=e.XpG(2);return e.Njj(r.nextStep())}),e.EFF(1," Next "),e.k0s()}}function Se(n,o){if(1&n&&(e.j41(0,"button",134),e.EFF(1),e.k0s()),2&n){const t=e.XpG(2);e.R7$(),e.SpI(" ",t.isEditMode?"Update":"Create"," Fee Structure ")}}function Pe(n,o){if(1&n){const t=e.RV6();e.j41(0,"div",37)(1,"h5",38),e.EFF(2),e.k0s(),e.j41(3,"button",39),e.bIt("click",function(){e.eBV(t);const r=e.XpG();return e.Njj(r.closeModal())}),e.k0s()(),e.j41(4,"div",40)(5,"div",41)(6,"div",42)(7,"div",43)(8,"span"),e.EFF(9,"1"),e.k0s(),e.j41(10,"small"),e.EFF(11,"Class & Year"),e.k0s()(),e.j41(12,"div",43)(13,"span"),e.EFF(14,"2"),e.k0s(),e.j41(15,"small"),e.EFF(16,"Frequency"),e.k0s()(),e.j41(17,"div",43)(18,"span"),e.EFF(19,"3"),e.k0s(),e.j41(20,"small"),e.EFF(21,"Fee Setup"),e.k0s()(),e.j41(22,"div",43)(23,"span"),e.EFF(24,"4"),e.k0s(),e.j41(25,"small"),e.EFF(26,"Review"),e.k0s()(),e.j41(27,"div",43)(28,"span"),e.EFF(29,"5"),e.k0s(),e.j41(30,"small"),e.EFF(31,"Submit"),e.k0s()()()(),e.j41(32,"form",44),e.bIt("ngSubmit",function(){e.eBV(t);const r=e.XpG();return e.Njj(r.submitFeeStructure())}),e.DNE(33,K,22,4,"div",45)(34,z,9,2,"div",45)(35,pe,23,3,"div",45)(36,Me,54,7,"div",45)(37,je,4,1,"div",45),e.j41(38,"div",46)(39,"button",47),e.bIt("click",function(){e.eBV(t);const r=e.XpG();return e.Njj(r.prevStep())}),e.EFF(40," Previous "),e.k0s(),e.DNE(41,Oe,2,0,"button",48)(42,Se,2,1,"button",49),e.j41(43,"button",50),e.bIt("click",function(){e.eBV(t);const r=e.XpG();return e.Njj(r.closeModal())}),e.EFF(44," Cancel "),e.k0s()()()()}if(2&n){const t=e.XpG();e.R7$(2),e.Lme(" ",t.isEditMode?"Edit Fee Structure":"Create Fee Structure"," - Step ",t.currentStep," of 5 "),e.R7$(5),e.AVh("active",1===t.currentStep)("completed",t.currentStep>1),e.R7$(5),e.AVh("active",2===t.currentStep)("completed",t.currentStep>2),e.R7$(5),e.AVh("active",3===t.currentStep)("completed",t.currentStep>3),e.R7$(5),e.AVh("active",4===t.currentStep)("completed",t.currentStep>4),e.R7$(5),e.AVh("active",5===t.currentStep),e.R7$(5),e.Y8G("formGroup",t.feeForm),e.R7$(),e.Y8G("ngIf",1===t.currentStep),e.R7$(),e.Y8G("ngIf",2===t.currentStep),e.R7$(),e.Y8G("ngIf",3===t.currentStep),e.R7$(),e.Y8G("ngIf",4===t.currentStep),e.R7$(),e.Y8G("ngIf",5===t.currentStep),e.R7$(2),e.Y8G("disabled",1===t.currentStep),e.R7$(2),e.Y8G("ngIf",t.currentStep<5),e.R7$(),e.Y8G("ngIf",5===t.currentStep)}}function $e(n,o){if(1&n){const t=e.RV6();e.j41(0,"div",135)(1,"h5",136),e.EFF(2,"Confirm Deletion"),e.k0s(),e.j41(3,"button",39),e.bIt("click",function(){const r=e.eBV(t).$implicit;return e.Njj(r.dismiss("cancel"))}),e.k0s()(),e.j41(4,"div",40),e.EFF(5," Are you sure you want to delete this fee structure? This action cannot be undone. "),e.k0s(),e.j41(6,"div",46)(7,"button",50),e.bIt("click",function(){const r=e.eBV(t).$implicit;return e.Njj(r.dismiss("cancel"))}),e.EFF(8,"Cancel"),e.k0s(),e.j41(9,"button",137),e.bIt("click",function(){const r=e.eBV(t).$implicit,a=e.XpG();return a.deleteFeeStructure(a.selectedStructureId),e.Njj(r.close("confirm"))}),e.EFF(10,"Delete"),e.k0s()()}}let xe=(()=>{class n{constructor(t,i,r,a,d,g,v,b){this.fb=t,this.feeService=i,this.authService=r,this.toastr=a,this.classService=d,this.academicYearService=g,this.routeService=v,this.modalService=b,this.feeStructures=[],this.classList=[],this.academicYears=[],this.routes=[],this.isEditMode=!1,this.selectedStructureId=null,this.currentStep=1,this.loading=!1,this.frequencies=["Monthly","Quarterly","Yearly","Specific Months"],this.feeTypes=["Base","Optional"],this.discountTypes=["Percentage","Fixed"],this.months=Array.from({length:12},(C,k)=>k+1),this.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],this.initialFeeCount=0,this.schoolId=this.authService.getSchoolId()||"",this.initializeForm()}ngOnInit(){this.schoolId?this.loadInitialData():this.toastr.error("School ID not found. Please log in again.")}initializeForm(){this.feeForm=this.fb.group({academicYearId:["",c.k0.required],classId:["",c.k0.required],frequency:["Monthly",c.k0.required],fees:this.fb.array([]),lateFeeConfig:this.fb.group({isEnabled:[!1],calculationType:["daily"],dailyRate:[0,[c.k0.min(0)]],fixedAmount:[0,[c.k0.min(0)]],percentageRate:[0,[c.k0.min(0)]],maxLateFee:[0,[c.k0.min(0)]],gracePeriodDays:[0,[c.k0.min(0)]]}),discounts:this.fb.array([])})}get fees(){return this.feeForm.get("fees")}get discounts(){return this.feeForm.get("discounts")}get lateFeeConfig(){return this.feeForm.get("lateFeeConfig")}loadInitialData(){this.loading=!0,Promise.all([this.loadClasses(),this.loadAcademicYears(),this.loadRoutes(),this.loadFeeStructures()]).finally(()=>this.loading=!1)}loadClasses(){return new Promise(t=>{this.classService.getClassesBySchool(this.schoolId).subscribe({next:i=>{this.classList=i,i.length||this.toastr.warning("No classes found. Please create a class first."),t()},error:i=>{this.toastr.error("Failed to load classes"),console.error("Error loading classes:",i),t()}})})}loadAcademicYears(){return new Promise(t=>{this.academicYearService.getAllAcademicYears(this.schoolId).subscribe({next:i=>{this.academicYears=i,i.length||this.toastr.warning("No academic years found. Please create an academic year first."),t()},error:i=>{this.toastr.error("Failed to load academic years"),console.error("Error loading academic years:",i),t()}})})}loadRoutes(){return new Promise(t=>{this.routeService.getRoutes().subscribe({next:i=>{this.routes=i.data||[],this.routes.length||this.toastr.warning("No transportation routes found. Transport fee will be disabled."),t()},error:i=>{this.toastr.error("Failed to load transportation routes"),console.error("Error loading routes:",i),t()}})})}loadFeeStructures(){return new Promise(t=>{this.feeService.getFeeStructures(this.schoolId).subscribe({next:i=>{this.feeStructures=i.data||[],this.feeStructures.length||this.toastr.info("No fee structures found. Create one to start."),t()},error:i=>{this.toastr.error("Failed to load fee structures"),console.error("Error loading fee structures:",i),t()}})})}openCreateModal(){if(!this.classList.length||!this.academicYears.length)return void this.toastr.warning("Please wait while data is loading or ensure classes and academic years are set up.");this.isEditMode=!1,this.currentStep=1,this.feeForm.reset({academicYearId:"",classId:"",frequency:"Monthly",lateFeeConfig:{isEnabled:!1,calculationType:"daily",dailyRate:0,fixedAmount:0,percentageRate:0,maxLateFee:0,gracePeriodDays:0}}),this.fees.clear(),this.discounts.clear(),this.addFee("tuitionFee","Base"),this.addFee("examFee","Base"),this.routes.length&&this.addTransportFee(),this.addFee("hostelFee","Optional","usesHostel"),this.addFee("miscFee","Base"),this.addFee("labFee","Base");const t=this.academicYears.find(i=>i.isActive);t&&this.feeForm.get("academicYearId")?.setValue(t._id),this.modalService.open(this.feeStructureModal,{size:"lg",backdrop:"static"})}openEditModal(t){this.isEditMode=!0,this.selectedStructureId=t,this.currentStep=1,this.feeForm.reset(),this.fees.clear(),this.discounts.clear();const i=this.feeStructures.find(r=>r._id===t);if(i){this.feeForm.patchValue({academicYearId:i.academicYearId._id,classId:i.classId._id,frequency:i.fees[0]?.frequency||"Monthly",lateFeeConfig:i.lateFeeConfig}),i.fees.forEach(a=>{if("transportFee"===a.name&&!this.routes.length)return;const d=this.fb.group({name:[a.name,c.k0.required],amount:[a.amount,[c.k0.required,c.k0.min(0)]],type:[a.type,c.k0.required],frequency:[a.frequency,c.k0.required],preferenceKey:[a.preferenceKey||null],routeOptions:this.fb.array(a.routeOptions?.map(g=>this.createRouteOption(g.routeId,g.amount))||[]),specificMonths:[a.specificMonths||[]]});this.fees.push(d)}),i.discounts.forEach(a=>{this.discounts.push(this.fb.group({name:[a.name,c.k0.required],type:[a.type,c.k0.required],amount:[a.amount,[c.k0.required,c.k0.min(0)]]}))});const r=this.academicYears.find(a=>a._id===i.academicYearId._id);r&&this.feeForm.get("academicYearId")?.setValue(r._id),this.modalService.open(this.feeStructureModal,{size:"lg",backdrop:"static"})}else this.toastr.error("Fee structure not found")}addFee(t,i,r){const a=this.fb.group({name:[t,c.k0.required],amount:[0,[c.k0.required,c.k0.min(0)]],type:[i,c.k0.required],frequency:[this.feeForm.get("frequency")?.value||"Monthly",c.k0.required],preferenceKey:[r||null],routeOptions:this.fb.array([]),specificMonths:[[]]});this.fees.push(a)}addTransportFee(){if(!this.routes.length)return;const t=this.fb.array([]);this.routes.forEach(r=>{t.push(this.createRouteOption(r._id,r.feeAmount))});const i=this.fb.group({name:["transportFee",c.k0.required],amount:[0,[c.k0.required,c.k0.min(0)]],type:["Optional",c.k0.required],frequency:[this.feeForm.get("frequency")?.value||"Monthly",c.k0.required],preferenceKey:["usesTransport"],routeOptions:t,specificMonths:[[]]});this.fees.push(i)}createRouteOption(t="",i=0){return this.fb.group({routeId:[t,t?[c.k0.required]:[]],amount:[i,[c.k0.required,c.k0.min(0)]]})}getRouteOptions(t){return this.fees.at(t).get("routeOptions")}addRouteOption(t){this.getRouteOptions(t).push(this.createRouteOption())}removeRouteOption(t,i){const r=this.getRouteOptions(t);r.length>1?r.removeAt(i):this.toastr.warning("At least one route option is required for transport fee.")}addDiscount(){this.discounts.push(this.fb.group({name:["",c.k0.required],type:["Percentage",c.k0.required],amount:[0,[c.k0.required,c.k0.min(0)]]}))}removeDiscount(t){this.discounts.removeAt(t)}confirmDelete(t){this.selectedStructureId=t,this.modalService.open(this.confirmDeleteModal,{centered:!0})}deleteFeeStructure(t){this.feeService.deleteFeeStructure(t).subscribe({next:()=>{this.toastr.success("Fee structure deleted successfully"),this.loadFeeStructures()},error:i=>{this.toastr.error(i.error?.message||"Failed to delete fee structure (e.g., invoices may exist)"),console.error("Error deleting fee structure:",i)}})}toggleSpecificMonths(t,i){const r=this.fees.at(t),a=r.get("specificMonths")?.value||[],d=a.indexOf(i);-1===d?a.push(i):a.splice(d,1),r.get("specificMonths")?.setValue(a)}isMonthSelected(t,i){return(this.fees.at(t).get("specificMonths")?.value||[]).includes(i)}updateRouteAmount(t,i,r){const d=r.target.value,g=this.routes.find(C=>C._id===d),v=this.getRouteOptions(t),b=this.fees.at(t);if(g){v.at(i).patchValue({routeId:d,amount:g.feeAmount});const C=v.controls.reduce((k,Re)=>k+(Re.value.amount||0),0);b.patchValue({amount:C})}else v.at(i).patchValue({routeId:"",amount:0}),b.patchValue({amount:0})}nextStep(){if(1===this.currentStep){if(!this.feeForm.get("academicYearId")?.value)return void this.toastr.error("Please select an academic year");if(!this.feeForm.get("classId")?.value)return void this.toastr.error("Please select a class")}else if(2===this.currentStep){if(!this.feeForm.get("frequency")?.value)return void this.toastr.error("Please select a frequency");this.fees.controls.forEach(t=>{(!this.isEditMode||t.value.frequency!==this.feeForm.get("frequency")?.value)&&t.patchValue({frequency:this.feeForm.get("frequency")?.value})})}else if(3===this.currentStep){for(let t=0;t<this.fees.length;t++){const i=this.fees.at(t);if(i.invalid)return void this.toastr.error(`Please fill all required fields for ${i.value.name}`);if("transportFee"===i.value.name&&i.value.amount>0&&this.routes.length){const r=this.getRouteOptions(t);if(0===r.length)return void this.toastr.error("Please add at least one route option for transport fee");for(let a=0;a<r.length;a++){const d=r.at(a);if(""===d.get("routeId")?.value)return void this.toastr.error("Please select a route for all route options");if(d.invalid)return void this.toastr.error("Please fill all required fields for route options")}}if("Specific Months"===i.value.frequency&&!i.value.specificMonths?.length)return void this.toastr.error(`Please select at least one month for ${i.value.name}`)}if(this.lateFeeConfig.value.isEnabled){const t=this.lateFeeConfig.value.calculationType;if("daily"===t&&this.lateFeeConfig.value.dailyRate<=0)return void this.toastr.error("Daily rate must be greater than 0");if("fixed"===t&&this.lateFeeConfig.value.fixedAmount<=0)return void this.toastr.error("Fixed amount must be greater than 0");if("percentage"===t&&this.lateFeeConfig.value.percentageRate<=0)return void this.toastr.error("Percentage rate must be greater than 0");if(this.lateFeeConfig.value.maxLateFee<=0)return void this.toastr.error("Maximum late fee must be greater than 0")}}this.currentStep++}prevStep(){this.currentStep>1&&this.currentStep--}submitFeeStructure(){if(this.feeForm.invalid)return this.toastr.error("Please fill all required fields"),void this.feeForm.markAllAsTouched();const t=this.authService.getUserId();if(!t)return void this.toastr.error("User ID not found. Please log in again.");const i={...this.feeForm.value,schoolId:this.schoolId,createdBy:t,_id:this.isEditMode?this.selectedStructureId:void 0,fees:this.feeForm.value.fees.map(a=>({...a,routeOptions:"transportFee"===a.name&&a.amount>0&&this.routes.length?a.routeOptions.filter(d=>d.routeId):[],specificMonths:"Specific Months"===a.frequency?a.specificMonths:[]})),academicYearId:{_id:this.feeForm.value.academicYearId,name:this.getAcademicYearName(this.feeForm.value.academicYearId)},classId:{_id:this.feeForm.value.classId,name:this.getClassName(this.feeForm.value.classId)}};(this.isEditMode?this.feeService.updateFeeStructure(this.selectedStructureId,i):this.feeService.createFeeStructure(i)).subscribe({next:()=>{this.toastr.success((this.isEditMode?"Updated":"Created")+" fee structure successfully"),this.loadFeeStructures(),this.closeModal()},error:a=>{this.toastr.error(a.error?.message||`Failed to ${this.isEditMode?"update":"create"} fee structure`),console.error(`Error ${this.isEditMode?"updating":"creating"} fee structure:`,a)}})}closeModal(){this.modalService.dismissAll(),this.currentStep=1,this.isEditMode=!1,this.selectedStructureId=null,this.feeForm.reset(),this.fees.clear(),this.discounts.clear()}getClassName(t){const i=this.classList.find(r=>r._id===t);return i?i.name:"N/A"}getAcademicYearName(t){const i=this.academicYears.find(r=>r._id===t);return i?i.name:"N/A"}getRouteName(t){const i=this.routes.find(r=>r._id===t);return i?`${i.name} (\u20b9${i.feeAmount})`:"N/A"}addCustomFee(){this.addFee("","Base")}static{this.\u0275fac=function(i){return new(i||n)(e.rXU(c.ok),e.rXU(h.G),e.rXU(p.u),e.rXU(y.tw),e.rXU(s.e),e.rXU(l.y),e.rXU(_.v),e.rXU(f.Bq))}}static{this.\u0275cmp=e.VBU({type:n,selectors:[["app-fee-structure"]],viewQuery:function(i,r){if(1&i&&(e.GBs(M,5),e.GBs(j,5)),2&i){let a;e.mGM(a=e.lsd())&&(r.feeStructureModal=a.first),e.mGM(a=e.lsd())&&(r.confirmDeleteModal=a.first)}},decls:34,vars:1,consts:[["noFeeStructures",""],["feeStructureModal",""],["confirmDeleteModal",""],["lateFeeDisabled",""],[1,"container-fluid","py-3"],[1,"card","custom-card"],[1,"card-header","text-white","d-flex","justify-content-between","align-items-center"],[1,"custom-btn",3,"click"],[1,"material-icons"],[1,"card-body"],[1,"table-container"],[1,"professional-table","table-striped","table-sm"],[4,"ngFor","ngForOf"],[1,"list-unstyled","mb-0","fee-list"],["class","mb-1",4,"ngFor","ngForOf"],["class","small",4,"ngIf","ngIfElse"],[1,"list-unstyled","mb-0"],["class","small",4,"ngFor","ngForOf"],["class","small text-muted",4,"ngIf"],[1,"material-icons",2,"cursor","pointer",3,"click"],[1,"material-icons",2,"cursor","pointer","color","red",3,"click"],[1,"mb-1"],["class","mt-1 small text-muted",4,"ngIf"],[1,"mt-1","small","text-muted"],[1,"list-unstyled","ms-2"],["class","xsmall",4,"ngFor","ngForOf"],[1,"xsmall"],["class","badge bg-secondary me-1",4,"ngFor","ngForOf"],[1,"badge","bg-secondary","me-1"],[1,"small"],[4,"ngIf"],[1,"text-muted","small"],[1,"small","text-muted"],["class","alert alert-info text-center py-2",4,"ngIf"],[1,"alert","alert-info","text-center","py-2"],[1,"fas","fa-info-circle","me-2"],[1,"fas","fa-spinner","fa-spin","me-2"],[1,"modal-header","text-white"],[1,"modal-title",2,"font-family","'Poppins', sans-serif","font-weight","600"],["type","button","aria-label","Close",1,"btn-close","btn-close-white",3,"click"],[1,"modal-body"],[1,"step-progress","mb-3"],[1,"steps"],[1,"step"],[3,"ngSubmit","formGroup"],["class","step-content",4,"ngIf"],[1,"modal-footer"],["type","button",1,"btn","btn-outline-secondary","btn-sm",3,"click","disabled"],["type","button","class","btn btn-primary btn-sm",3,"click",4,"ngIf"],["type","submit","class","btn btn-success btn-sm",4,"ngIf"],["type","button",1,"btn","btn-outline-secondary","btn-sm",3,"click"],[1,"step-content"],[1,"row","g-2"],[1,"col-md-6"],[1,"form-label"],[1,"text-danger"],["formControlName","classId",1,"form-select","form-select-sm","shadow-sm"],["value",""],[3,"value",4,"ngFor","ngForOf"],["class","text-danger small",4,"ngIf"],["formControlName","academicYearId",1,"form-select","form-select-sm","shadow-sm"],[3,"value"],[1,"text-danger","small"],[1,"mb-2"],["formControlName","frequency",1,"form-select","form-select-sm","shadow-sm"],["formArrayName","fees",1,"fee-items"],["class","fee-item mb-3 p-2 border rounded",3,"formGroupName",4,"ngFor","ngForOf"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-2",3,"click"],[1,"fas","fa-plus"],[1,"mt-3"],[1,"border-bottom","pb-1","mb-2"],["formGroupName","lateFeeConfig",1,"p-2","border","rounded"],[1,"form-check","form-switch","mb-2"],["type","checkbox","formControlName","isEnabled","id","lateFeeSwitch",1,"form-check-input"],["for","lateFeeSwitch",1,"form-check-label"],["class","row g-2",4,"ngIf"],["formArrayName","discounts",1,"mt-3"],[1,"discounts-list"],["class","d-flex gap-2 mb-2 align-items-end",3,"formGroupName",4,"ngFor","ngForOf"],["type","button",1,"btn","btn-sm","btn-outline-primary","mt-1",3,"click"],[1,"fee-item","mb-3","p-2","border","rounded",3,"formGroupName"],[1,"row","g-2","align-items-end"],[1,"col-md-4"],["formControlName","name",1,"form-control","form-control-sm",3,"readonly"],[1,"col-md-2"],["formControlName","type",1,"form-control","form-control-sm",3,"readonly"],[1,"col-md-3"],[1,"input-group","input-group-sm"],[1,"input-group-text"],["type","number","formControlName","amount",1,"form-control"],["class","mt-1",4,"ngIf"],["class","mt-2",4,"ngIf"],[1,"mt-1"],[1,"d-flex","flex-wrap","gap-1"],["type","button","class","btn btn-sm month-btn",3,"btn-primary","btn-outline-primary","click",4,"ngFor","ngForOf"],["type","button",1,"btn","btn-sm","month-btn",3,"click"],[1,"mt-2"],["formArrayName","routeOptions",1,"route-options-list"],["class","d-flex gap-2 mb-1 align-items-end",3,"formGroupName",4,"ngFor","ngForOf"],[1,"d-flex","gap-2","mb-1","align-items-end",3,"formGroupName"],[1,"flex-grow-1"],["formControlName","routeId",1,"form-select","form-select-sm","shadow-sm",3,"change"],["type","button",1,"btn","btn-sm","btn-outline-danger",3,"click"],[1,"fas","fa-trash"],["formControlName","calculationType",1,"form-select","form-select-sm","shadow-sm"],["value","daily"],["value","fixed"],["value","percentage"],["type","number","formControlName","gracePeriodDays",1,"form-control","form-control-sm"],["class","col-md-6",4,"ngIf"],["type","number","formControlName","maxLateFee",1,"form-control"],["type","number","formControlName","dailyRate",1,"form-control"],["type","number","formControlName","fixedAmount",1,"form-control"],["type","number","formControlName","percentageRate",1,"form-control"],[1,"d-flex","gap-2","mb-2","align-items-end",3,"formGroupName"],["type","text","formControlName","name",1,"form-control","form-control-sm"],["formControlName","type",1,"form-select","form-select-sm","shadow-sm"],["value","Percentage"],["value","Fixed"],["class","input-group-text",4,"ngIf"],[1,"border-bottom","pb-2","mb-3"],[1,"card","mb-2"],[1,"card-header","bg-light"],[1,"mb-0"],[1,"card-body","p-2"],[1,"row"],[1,"table-responsive"],[1,"table","table-sm"],[4,"ngIf","ngIfElse"],["class","card mb-2",4,"ngIf"],[1,"text-muted"],[1,"text-muted","mb-0"],[1,"alert","alert-info"],["type","button",1,"btn","btn-primary","btn-sm",3,"click"],["type","submit",1,"btn","btn-success","btn-sm"],[1,"modal-header","bg-danger","text-white"],[1,"modal-title"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"]],template:function(i,r){if(1&i){const a=e.RV6();e.j41(0,"div",4)(1,"div",5)(2,"div",6)(3,"button",7),e.bIt("click",function(){return e.eBV(a),e.Njj(r.openCreateModal())}),e.j41(4,"span",8),e.EFF(5,"add_circle"),e.k0s(),e.EFF(6," Create Fee Structure "),e.k0s()(),e.j41(7,"div",9)(8,"div",10)(9,"table",11)(10,"thead")(11,"tr")(12,"th"),e.EFF(13,"#"),e.k0s(),e.j41(14,"th"),e.EFF(15,"Class"),e.k0s(),e.j41(16,"th"),e.EFF(17,"Academic Year"),e.k0s(),e.j41(18,"th"),e.EFF(19,"Fees"),e.k0s(),e.j41(20,"th"),e.EFF(21,"Late Fee"),e.k0s(),e.j41(22,"th"),e.EFF(23,"Discounts"),e.k0s(),e.j41(24,"th"),e.EFF(25,"Actions"),e.k0s()()(),e.j41(26,"tbody"),e.DNE(27,A,23,8,"tr",12),e.k0s()(),e.DNE(28,X,2,2,"ng-template",null,0,e.C5r),e.k0s()()(),e.DNE(30,Pe,45,29,"ng-template",null,1,e.C5r)(32,$e,11,0,"ng-template",null,2,e.C5r),e.k0s()}2&i&&(e.R7$(27),e.Y8G("ngForOf",r.feeStructures))},dependencies:[m.MD,m.Sq,m.bT,m.PV,c.X1,c.qT,c.xH,c.y7,c.me,c.Q0,c.Zm,c.wz,c.BC,c.cb,c.j4,c.JD,c.$R,c.v8,c.YN],styles:['.steps[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-bottom:20px}.steps[_ngcontent-%COMP%]   .step[_ngcontent-%COMP%]{text-align:center;flex:1;position:relative}.steps[_ngcontent-%COMP%]   .step[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{display:inline-block;width:30px;height:30px;line-height:30px;border-radius:50%;background:#e0e0e0;color:#333;margin-bottom:5px}.steps[_ngcontent-%COMP%]   .step.active[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{background:#007bff;color:#fff}.steps[_ngcontent-%COMP%]   .step.completed[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{background:#28a745;color:#fff}.steps[_ngcontent-%COMP%]   .step[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{display:block;font-size:12px}.steps[_ngcontent-%COMP%]   .step[_ngcontent-%COMP%]:not(:last-child):after{content:"";position:absolute;top:15px;right:-50%;width:100%;height:2px;background:#e0e0e0;z-index:-1}.steps[_ngcontent-%COMP%]   .step.active[_ngcontent-%COMP%]:not(:last-child):after, .steps[_ngcontent-%COMP%]   .step.completed[_ngcontent-%COMP%]:not(:last-child):after{background:#007bff}.fee-item[_ngcontent-%COMP%]{background:#f8f9fa}.route-options-list[_ngcontent-%COMP%]{max-height:300px;overflow-y:auto}.modal-header[_ngcontent-%COMP%]{background:linear-gradient(90deg,#2c3e50,#3498db)}.modal-header[_ngcontent-%COMP%]   h5[_ngcontent-%COMP%]{color:#fff}.month-selection[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:5px}.month-selection[_ngcontent-%COMP%]   .month-btn[_ngcontent-%COMP%]{min-width:80px}.table-responsive[_ngcontent-%COMP%]{max-height:400px;overflow-y:auto}.container-fluid[_ngcontent-%COMP%]{font-family:Poppins,sans-serif}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]{border:none;border-radius:8px;box-shadow:0 2px 6px #0000001a}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-header[_ngcontent-%COMP%]{border-radius:8px 8px 0 0;padding:10px 15px}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:18px}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-header[_ngcontent-%COMP%]   .btn-sm[_ngcontent-%COMP%]{font-size:12px;padding:4px 10px;border-radius:4px}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{padding:15px}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .professional-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;border-radius:6px;overflow:hidden;font-size:13px}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .professional-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{background-color:#2c3e50;color:#fff}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .professional-table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:8px;text-align:left;font-weight:600;font-size:13px}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .professional-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{border-bottom:1px solid #ECF0F1;transition:background-color .2s}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .professional-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:nth-child(2n){background-color:#f9fbfc}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .professional-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:hover{background-color:#f0f4f8}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .professional-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:8px;vertical-align:middle;font-size:12px;color:#34495e}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .professional-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .fee-list[_ngcontent-%COMP%]{list-style:none;padding:0;margin:0}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .professional-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .fee-list[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{margin-bottom:4px}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .professional-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]   .xsmall[_ngcontent-%COMP%]{font-size:11px}.container-fluid[_ngcontent-%COMP%]   .custom-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .alert-info[_ngcontent-%COMP%]{font-size:13px;padding:10px;margin:0}']})}}return n})()},2329:(E,F,u)=>{u.d(F,{G:()=>h});var c=u(2525),m=u(4438),e=u(1626);let h=(()=>{class p{constructor(s){this.http=s,this.apiUrl=c.c.apiUrl}getFeeStructures(s){return this.http.get(`${this.apiUrl}/api/fees/structures`,{params:{schoolId:s}})}getStudentInvoices(s,l){const _={};return l&&(_.academicYearId=l),this.http.get(`${this.apiUrl}/api/fees/invoices/student/${s}`,{params:_})}searchInvoiceStudents(s,l){return this.http.get(`${this.apiUrl}/api/fees/search`,{params:{q:s,schoolId:l}})}createFeeStructure(s){return this.http.post(`${this.apiUrl}/api/fees/structures`,s)}updateFeeStructure(s,l){return this.http.put(`${this.apiUrl}/api/fees/structures/${s}`,l)}deleteFeeStructure(s){return this.http.delete(`${this.apiUrl}/api/fees/structures/${s}`)}generateInvoices(s){return this.http.post(`${this.apiUrl}/api/fees/generate`,s)}getStudentFeeSummary(s){return this.http.get(`${this.apiUrl}/api/fees/students/${s}/summary`)}getInvoiceById(s){return this.http.get(`${this.apiUrl}/api/fees/invoices/${s}`)}generateAdvanceInvoices(s){return this.http.post(`${this.apiUrl}/api/fees/invoices/advance`,s)}processPayment(s,l){return this.http.post(`${this.apiUrl}/api/fees/students/${s}/payments`,l)}getFeeCollectionReport(s){return this.http.get(`${this.apiUrl}/api/fees/reports/collection-details`,{params:s})}generateClassReceipts(s){return this.http.post(`${this.apiUrl}/api/fees/receipts`,s,{responseType:"blob"})}getPaidInvoiceList(s){return this.http.get(`${this.apiUrl}/api/fees/paid-invoices`,{params:s})}getInvoicesByClassAndMonth(s,l,_){return this.http.get(`${this.apiUrl}/api/fees/invoices`,{params:{classId:s,month:l,academicYearId:_}})}getStudentPaymentHistory(s){return this.http.get(`${this.apiUrl}/api/fees/students/${s}/payment-history`)}downloadInvoicePDF(s){return this.http.get(`${this.apiUrl}/api/fees/invoices/${s}/pdf`,{responseType:"blob"})}downloadReceiptPDF(s){return this.http.get(`${this.apiUrl}/api/fees/receipts/${s}/pdf`,{responseType:"blob"})}notifyParents(s,l,_){return this.http.post(`${this.apiUrl}/api/fees/notify-parents`,{classId:s,month:l,academicYearId:_})}static{this.\u0275fac=function(l){return new(l||p)(m.KVO(e.Qq))}}static{this.\u0275prov=m.jDH({token:p,factory:p.\u0275fac,providedIn:"root"})}}return p})()}}]);