<ul class="list-unstyled">
  <li class="pc-h-item">
    <div class="row mb-3">
      <div class="col-md-12">
        <button class="btn btn-primary" (click)="openUpgradeModal(upgradeModal)" *ngIf="role === 'admin'">Upgrade</button>
        <div class="d-flex justify-content-between align-items-center" *ngIf="authService.getUserRole() === 'admin'">
          <div *ngIf="isExpiringSoon && !isExpired && !isPending" class="alert alert-warning alert-dismissible fade show" role="alert">
            Your plan expires in {{ subscriptionData.daysRemaining }} days.
            <button
            class="btn btn-primary"
            (click)="openUpgradeModal(upgradeModal)"
            *ngIf="role === 'admin' && subscriptionData.subscriptionStatus !== 'active'">
            Upgrade
          </button>
          <div *ngIf="subscriptionData.subscriptionStatus === 'active'" class="alert alert-success p-2 mb-0">
            <strong>{{ subscriptionData.name }}</strong>
            <span *ngIf="subscriptionData.isTrial"> (Trial – {{ subscriptionData.daysRemaining }} days left)</span>
            <span *ngIf="!subscriptionData.isTrial"> until {{ subscriptionData.expiresAt | date:'mediumDate' }}</span>
          </div>
          </div>
          <div *ngIf="isExpired" class="alert alert-danger alert-dismissible fade show" role="alert">
            Your subscription has expired. You can only view data.
            <a href="javascript:void(0)" (click)="openUpgradeModal(upgradeModal)">Renew now</a>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          <div *ngIf="isPending" class="alert alert-info alert-dismissible fade show" role="alert">
            Your payment is pending verification. You can only view data until approved.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        </div>
      </div>
    </div>
  </li>

  <li class="dropdown pc-h-item" ngbDropdown>
  <a class="pc-head-link dropdown-toggle arrow-none position-relative" style="background-color: #e9ecef;" ngbDropdownToggle>
    <i antIcon type="bell" theme="outline" class="f-20"></i>
  <span 
  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
  *ngIf="notificationCount > 0">
  <span class="visually-hidden">unread notifications</span>
  {{ notificationCount > 99 ? '99+' : notificationCount }}
</span>
  </a>

  <div class="dropdown-menu dropdown-menu-end dropdown-notification pc-h-dropdown" ngbDropdownMenu>
    <div class="dropdown-header d-flex align-items-center justify-content-between bg-light">
      <h5 class="mb-0">Notifications</h5>
      <small class="text-muted">{{ notifications.length }} total</small>
    </div>

    <ng-scrollbar class="notification-scroll" style="height: 320px">
      <div class="list-group list-group-flush">
        <a 
          href="javascript:" 
          class="list-group-item list-group-item-action border-0 px-3 py-2"
          *ngFor="let n of notifications"
          (click)="markAsRead(n._id)"
          [class.bg-light-primary]="n.status !== 'read' && n.status !== 'delivered'">

          <div class="d-flex align-items-start">
            <div class="flex-shrink-0 mt-1">
              <div class="avatar-sm bg-soft-primary rounded-circle d-flex align-items-center justify-content-center">
                <i antIcon theme="outline" [type]="
                  n.type === 'announcement' ? 'sound' :
                  n.type === 'assignment' ? 'file-text' :
                  n.type === 'progress-report' ? 'trophy' : 'bell'
                "></i>
              </div>
            </div>

            <div class="flex-grow-1 ms-3 overflow-hidden">
              <h6 class="mb-1 text-truncate" style="max-width: 220px;">
                {{ n.title }}
              </h6>
              <p class="mb-1 text-muted small text-truncate" style="max-width: 220px;">
                {{ n.message }}
              </p>
              <small class="text-muted">
                {{ n.senderId?.name || 'System' }} • {{ n.createdAt | date:'short' }}
              </small>
            </div>
          </div>
        </a>
      </div>

      <div class="text-center py-3 text-muted small" *ngIf="notifications.length === 0">
        No new notifications
      </div>
    </ng-scrollbar>

    <div class="dropdown-footer text-center py-2 bg-light">
      <a routerLink="/notifications/all" class="small link-primary">View All Notifications</a>
    </div>
  </div>
</li>
  <li class="dropdown pc-h-item header-user-profile" ngbDropdown>
    <a class="pc-head-link dropdown-toggle arrow-none me-0" ngbDropdownToggle (click)="playNotificationSound()">
      <img src="assets/images/user/avatar-2.jpg" alt="user-image" class="user-avatar me-2" />
      <span class="f-w-600">{{ username }}</span>
    </a>
    <div class="dropdown-menu dropdown-user-profile dropdown-menu-end pc-h-dropdown" ngbDropdownMenu>
      <div class="dropdown-header">
        <div class="d-flex mb-1">
          <div class="flex-shrink-0">
            <img src="assets/images/user/avatar-2.jpg" alt="user-image" class="user-avatar wid-35" />
          </div>
          <div class="flex-grow-1 ms-3 text-start">
            <h6 class="mb-0">{{ username }}</h6>
            <span>{{ role }}</span>
          </div>
          <a href="javascript:" class="bg-transparent"><i class="d-flex f-20" antIcon theme="outline" type="logout"></i></a>
        </div>
      </div>
      <ul ngbNav #nav="ngbNav" class="nav drp-tabs nav-fill nav-tabs">
        <li ngbNavItem="1">
          <a ngbNavLink>
            <i antIcon theme="outline" type="user" class="me-2"></i>
            Profile
          </a>
          <ng-template ngbNavContent>
            @for (task of filteredProfile; track task) {
              <div>
                <a class="dropdown-item" [routerLink]="task.link">
                  <i class="text-muted" antIcon theme="outline" type="{{ task.icon }}"></i>
                  <span>{{ task.title }}</span>
                </a>
              </div>
            }
            <div>
              <a class="dropdown-item" (click)="logOut()">
                <i class="text-muted" antIcon theme="outline" type="logout"></i>
                <span>Logout</span>
              </a>
            </div>
          </ng-template>
        </li>
        <li ngbNavItem="2">
          <a ngbNavLink>
            <i class="me-2" antIcon theme="outline" type="setting"></i>
            Setting
          </a>
          <ng-template ngbNavContent>
            @for (task of setting; track task) {
              <div>
                <a class="dropdown-item">
                  <i class="text-muted" antIcon theme="outline" type="{{ task.icon }}"></i>
                  <span>{{ task.title }}</span>
                </a>
              </div>
            }
          </ng-template>
        </li>
      </ul>
      <div [ngbNavOutlet]="nav"></div>
    </div>
  </li>
</ul>

<ng-template #upgradeModal>
  <div class="modal-header" style="background: linear-gradient(90deg, #4a90e2, #50c9c3);">
    <h4 class="modal-title" style="color: white;">Upgrade Your Subscription</h4>
    <button type="button" class="btn-close" (click)="modalService.dismissAll()" aria-label="Close"></button>
  </div>
  <div class="modal-body" style="background: #f8f9fa; padding: 20px;">
    <div class="row">
      <div class="col-12 mb-4 text-center">
        <p *ngIf="subscriptionData.planType">
          Current Plan: <strong>{{ subscriptionData.planType | titlecase }}</strong>
          (Expired: {{ subscriptionData.expiresAt | date:'mediumDate' }})
        </p>
        <p *ngIf="isExpired" class="text-danger">Your subscription has expired. Select a new plan to continue.</p>
        <p *ngIf="isPending" class="text-info">Payment pending. Upload proof if needed.</p>
      </div>

      <!-- Step 1: Select Plan -->
      <div class="col-12 mb-4" *ngIf="!selectedPlan">
        <h5 class="text-dark">Choose Your Plan</h5>
        <div class="pricing-container">
          <div class="pricing-card" *ngFor="let plan of plans">
            <div class="plan-label">{{ plan.name }}</div>
            <div class="price">₹{{ plan.price }}<span>/{{ plan.value.split('_')[1] === 'monthly' ? 'month' : 'year' }}</span></div>
            <div class="subtitle">{{ plan.value === 'basic_monthly' ? 'Basic features' : 'Premium features' }}</div>
            <ul class="features">
              <li *ngFor="let feature of plan.features">{{ feature }}</li>
            </ul>
            <button class="btn plan-select-btn" (click)="selectPlan(plan.value)" [ngClass]="{'selected': selectedPlan === plan.value}">
              Get Started
            </button>
            <div *ngIf="plan.discount > 0" class="discount">
              <span class="original-price">₹{{ plan.originalPrice }}</span>
              <span class="saved">Save ₹{{ plan.discount }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Select Payment Method -->
<div class="col-12" *ngIf="selectedPlan">
  <h5 class="text-dark">Choose Payment Method</h5>
  <div class="payment-options">
    <button class="btn payment-method-btn" (click)="selectPaymentMethod('razorpay')" [ngClass]="{'selected': selectedPaymentMethod === 'razorpay'}">
      Card/UPI/Wallet/Netbanking (Recommended)
    </button>
    <!-- <button class="btn payment-method-btn" (click)="selectPaymentMethod('bank_transfer')" [ngClass]="{'selected': selectedPaymentMethod === 'bank_transfer'}">
      Bank Transfer
    </button> -->
  </div>

  <!-- Unified Pay Now for Razorpay (no form needed) -->
  <div *ngIf="selectedPaymentMethod === 'razorpay'" class="payment-form mt-4 text-center">
    <p class="text-muted mb-4">You'll be redirected to a secure payment page. Supports cards, UPI (PhonePe/GPay), wallets, and more.</p>
    <button class="btn btn-primary btn-lg" (click)="upgradePlan()" [disabled]="isLoading">
      <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      Pay Now ₹{{ getPlanPrice(selectedPlan) }}
    </button>
  </div>

  <!-- Bank Transfer (keep as-is, since it's manual) -->
  <div *ngIf="selectedPaymentMethod === 'bank_transfer' && bankDetails" class="payment-form mt-4">
    <!-- Your existing bank details + file upload code -->
  </div>
</div>
    </div>
  </div>
  <div class="modal-footer" style="background: linear-gradient(90deg, #4a90e2, #50c9c3);">
    <button class="btn btn-secondary" (click)="modalService.dismissAll()" [disabled]="isLoading">Cancel</button>
  </div>
</ng-template>