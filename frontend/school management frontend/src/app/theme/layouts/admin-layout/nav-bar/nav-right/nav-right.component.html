<ul class="list-unstyled">
  <li class="pc-h-item">
    <div class="row mb-3">
      <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center" *ngIf="authService.getUserRole() === 'admin'">
          <div *ngIf="isExpiringSoon && !isExpired && !isPending" class="alert alert-warning alert-dismissible fade show" role="alert">
            Your plan expires in {{ subscriptionData.daysRemaining }} days.
            <a href="javascript:void(0)" (click)="openUpgradeModal(upgradeModal)">Upgrade now</a>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          <div *ngIf="isExpired" class="alert alert-danger alert-dismissible fade show" role="alert">
            Your subscription has expired. You can only view data.
            <a href="javascript:void(0)" (click)="openUpgradeModal(upgradeModal)">Renew now</a>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          <div *ngIf="isPending" class="alert alert-info alert-dismissible fade show" role="alert">
            Your payment is pending verification. You can only view data until approved.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          <button class="btn btn-primary" (click)="openUpgradeModal(upgradeModal)">
            <i class="fas fa-star me-1"></i> Subscription
          </button>
        </div>
      </div>
    </div>
  </li>
  <li class="dropdown pc-h-item" ngbDropdown>
    <a class="pc-head-link dropdown-toggle arrow-none me-0 bg-gray-200" data-bs-toggle="dropdown" ngbDropdownToggle>
      <i antIcon type="bell" theme="outline"></i>
      <span class="badge bg-primary pc-h-badge">3</span>
    </a>
    <div class="dropdown-menu dropdown-notification dropdown-menu-end pc-h-dropdown" ngbDropdownMenu>
      <div class="dropdown-header d-flex align-items-center justify-content-between">
        <h5 class="m-0">Notification</h5>
        <a class="bg-transparent"><i class="text-success d-flex f-20" antIcon theme="outline" type="check-circle"></i></a>
      </div>
      <div class="dropdown-divider"></div>
      <ng-scrollbar style="min-height: 300px" visibility="hover">
        <div class="dropdown-header px-0 text-wrap header-notification-scroll">
          <div class="list-group list-group-flush w-100">
            <a class="list-group-item list-group-item-action">
              <div class="d-flex">
                <div class="flex-shrink-0">
                  <div class="user-avatar bg-light-success"><i class="d-flex" antIcon theme="outline" type="gift"></i></div>
                </div>
                <div class="flex-grow-1 ms-3">
                  <span class="float-end text-muted">3:00 AM</span>
                  <p class="text-body mb-0">
                    It's
                    <b>Cristina danny's</b>
                    birthday today.
                  </p>
                  <span class="text-muted">2 min ago</span>
                </div>
              </div>
            </a>
            <a class="list-group-item list-group-item-action">
              <div class="d-flex">
                <div class="flex-shrink-0">
                  <div class="user-avatar bg-light-primary"><i class="d-flex" antIcon theme="outline" type="message"></i></div>
                </div>
                <div class="flex-grow-1 ms-3">
                  <span class="float-end text-muted">6:00 PM</span>
                  <p class="text-body mb-1">
                    <b>Aida Burg</b>
                    commented your post.
                  </p>
                  <span class="text-muted">5 August</span>
                </div>
              </div>
            </a>
            <a class="list-group-item list-group-item-action">
              <div class="d-flex">
                <div class="flex-shrink-0">
                  <div class="user-avatar bg-light-danger"><i class="d-flex" antIcon theme="outline" type="setting"></i></div>
                </div>
                <div class="flex-grow-1 ms-3">
                  <span class="float-end text-muted">2:45 PM</span>
                  <p class="text-body mb-1">
                    Your Profile is Complete
                    <b>60%</b>
                  </p>
                  <span class="text-muted">7 hours ago</span>
                </div>
              </div>
            </a>
            <a class="list-group-item list-group-item-action">
              <div class="d-flex">
                <div class="flex-shrink-0">
                  <div class="user-avatar bg-light-primary"><i class="d-flex" antIcon theme="outline" type="phone"></i></div>
                </div>
                <div class="flex-grow-1 ms-3">
                  <span class="float-end text-muted">9:10 PM</span>
                  <p class="text-body mb-1">
                    <b>Cristina Danny</b>
                    invited to join
                    <b>Meeting.</b>
                  </p>
                  <span class="text-muted">Daily scrum meeting time</span>
                </div>
              </div>
            </a>
          </div>
        </div>
      </ng-scrollbar>
      <div class="dropdown-divider"></div>
      <div class="text-center py-2">
        <a class="link-primary">View all</a>
      </div>
    </div>
  </li>
  <li class="dropdown pc-h-item header-user-profile" ngbDropdown>
    <a class="pc-head-link dropdown-toggle arrow-none me-0" ngbDropdownToggle>
      <img src="assets/images/user/avatar-2.jpg" alt="user-image" class="user-avatar me-2" />
      <span class="f-w-600">{{ username }}</span>
    </a>
    <div class="dropdown-menu dropdown-user-profile dropdown-menu-end pc-h-dropdown" ngbDropdownMenu>
      <div class="dropdown-header">
        <div class="d-flex mb-1">
          <div class="flex-shrink-0">
            <img src="assets/images/user/avatar-2.jpg" alt="user-image" class="user-avatar wid-35" />
          </div>
          <div class="flex-grow-1 ms-3 text-start">
            <h6 class="mb-0">{{ username }}</h6>
            <span>{{ role }}</span>
          </div>
          <a href="javascript:" class="bg-transparent"><i class="d-flex f-20" antIcon theme="outline" type="logout"></i></a>
        </div>
      </div>
      <ul ngbNav #nav="ngbNav" class="nav drp-tabs nav-fill nav-tabs">
        <li ngbNavItem="1">
          <a ngbNavLink>
            <i antIcon theme="outline" type="user" class="me-2"></i>
            Profile
          </a>
          <ng-template ngbNavContent>
            @for (task of profile; track task) {
              <div>
                <a class="dropdown-item" [routerLink]="task.link">
                  <i class="text-muted" antIcon theme="outline" type="{{ task.icon }}"></i>
                  <span>{{ task.title }}</span>
                </a>
              </div>
            }
            <div>
              <a class="dropdown-item" (click)="logOut()">
                <i class="text-muted" antIcon theme="outline" type="logout"></i>
                <span>Logout</span>
              </a>
            </div>
          </ng-template>
        </li>
        <li ngbNavItem="2">
          <a ngbNavLink>
            <i class="me-2" antIcon theme="outline" type="setting"></i>
            Setting
          </a>
          <ng-template ngbNavContent>
            @for (task of setting; track task) {
              <div>
                <a class="dropdown-item">
                  <i class="text-muted" antIcon theme="outline" type="{{ task.icon }}"></i>
                  <span>{{ task.title }}</span>
                </a>
              </div>
            }
          </ng-template>
        </li>
      </ul>
      <div [ngbNavOutlet]="nav"></div>
    </div>
  </li>
</ul>

<ng-template #upgradeModal>
  <div class="modal-header" style="background: linear-gradient(90deg, #4a90e2, #50c9c3);">
    <h4 class="modal-title" style="color: white;">Upgrade Your Subscription</h4>
    <button type="button" class="btn-close" (click)="modalService.dismissAll()" aria-label="Close"></button>
  </div>
  <div class="modal-body" style="background: #f8f9fa; padding: 20px;">
    <div class="row">
      <div class="col-12 mb-4 text-center">
        <p *ngIf="subscriptionData.planType">
          Current Plan: <strong>{{ subscriptionData.planType | titlecase }}</strong>
          (Expired: {{ subscriptionData.expiresAt | date:'mediumDate' }})
        </p>
        <p *ngIf="isExpired" class="text-danger">Your subscription has expired. Select a new plan to continue.</p>
        <p *ngIf="isPending" class="text-info">Payment pending. Upload proof if needed.</p>
      </div>

      <!-- Step 1: Select Plan -->
      <div class="col-12 mb-4" *ngIf="!selectedPlan">
        <h5 class="text-dark">Choose Your Plan</h5>
        <div class="pricing-container">
          <div class="pricing-card" *ngFor="let plan of plans">
            <div class="plan-label">{{ plan.name }}</div>
            <div class="price">₹{{ plan.price }}<span>/{{ plan.value.split('_')[1] === 'monthly' ? 'month' : 'year' }}</span></div>
            <div class="subtitle">{{ plan.value === 'basic_monthly' ? 'Basic features' : 'Premium features' }}</div>
            <ul class="features">
              <li *ngFor="let feature of plan.features">{{ feature }}</li>
            </ul>
            <button class="btn plan-select-btn" (click)="selectPlan(plan.value)" [ngClass]="{'selected': selectedPlan === plan.value}">
              Get Started
            </button>
            <div *ngIf="plan.discount > 0" class="discount">
              <span class="original-price">₹{{ plan.originalPrice }}</span>
              <span class="saved">Save ₹{{ plan.discount }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Select Payment Method -->
      <div class="col-12" *ngIf="selectedPlan">
        <h5 class="text-dark">Choose Payment Method</h5>
        <div class="payment-options">
          <button class="btn payment-method-btn" (click)="selectPaymentMethod('phonepe')" [ngClass]="{'selected': selectedPaymentMethod === 'phonepe'}">
            PhonePe
          </button>
          <button class="btn payment-method-btn" (click)="selectPaymentMethod('razorpay')" [ngClass]="{'selected': selectedPaymentMethod === 'razorpay'}">
            Online (Card/UPI)
          </button>
          <button class="btn payment-method-btn" (click)="selectPaymentMethod('bank_transfer')" [ngClass]="{'selected': selectedPaymentMethod === 'bank_transfer'}">
            Bank Transfer
          </button>
        </div>

        <!-- PhonePe UPI Field -->
        <div *ngIf="selectedPaymentMethod === 'phonepe'" class="payment-form mt-4">
          <p class="text-muted">Enter your UPI ID to proceed with PhonePe payment.</p>
          <input type="text" class="form-control mb-3" placeholder="e.g., user@phonepe" [(ngModel)]="upiId" />
          <button class="btn btn-primary" (click)="upgradePlan()" [disabled]="!upiId || isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            Pay Now
          </button>
        </div>

        <!-- Online (Card/UPI) - Direct to Razorpay -->
        <div *ngIf="selectedPaymentMethod === 'razorpay'" class="payment-form mt-4">
          <p class="text-muted">You will be redirected to a secure payment page for Card or UPI.</p>
          <button class="btn btn-primary" (click)="upgradePlan()" [disabled]="isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            Pay Now
          </button>
        </div>

        <!-- Bank Transfer Details -->
        <div *ngIf="selectedPaymentMethod === 'bank_transfer' && bankDetails" class="bank-transfer-details mt-4">
          <div class="card">
            <div class="card-body">
              <h6>Bank Transfer Details</h6>
              <p>Account Name: {{ bankDetails.accountName }}</p>
              <p>Account Number: {{ bankDetails.accountNumber }}</p>
              <p>IFSC Code: {{ bankDetails.ifscCode }}</p>
              <p>Bank: {{ bankDetails.bankName }} ({{ bankDetails.branch }})</p>
              <p>Amount: ₹{{ bankDetails.amount }}</p>
              <p>Reference: {{ bankDetails.reference }}</p>
              <div class="mb-3 mt-3">
                <label for="paymentProof" class="form-label">Upload Payment Proof (JPG/PNG/PDF)</label>
                <input type="file" class="form-control" id="paymentProof" accept="image/jpeg,image/png,application/pdf" (change)="onFileChange($event)">
              </div>
              <button class="btn btn-primary" (click)="uploadPaymentProof()" [disabled]="!paymentProof || isLoading">
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Upload Proof
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer" style="background: linear-gradient(90deg, #4a90e2, #50c9c3);">
    <button class="btn btn-secondary" (click)="modalService.dismissAll()" [disabled]="isLoading">Cancel</button>
  </div>
</ng-template>