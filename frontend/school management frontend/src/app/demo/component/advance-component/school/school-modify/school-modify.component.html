<div class="student-container">
  <!-- Header -->
  <div class="header-section">
    <div class="header-card">
      <h1 class="title">Update School Profile</h1>
      <p class="subtitle">Manage your institution details, logo, and location</p>
    </div>
  </div>

  <!-- Main Card -->
  <div class="controls-section">
    <div class="controls-card">
      <form [formGroup]="schoolForm" (ngSubmit)="updateSchool()" novalidate>

        <!-- Coordinates Status Alert -->
        <div class="alert mb-4" 
             [ngClass]="{'alert-success': areCoordinatesValid(), 'alert-warning': !areCoordinatesValid()}">
          <div class="d-flex align-items-center">
            <i class="fas fa-2x me-3" 
               [ngClass]="areCoordinatesValid() ? 'fa-check-circle text-success' : 'fa-map-marker-alt text-warning'"></i>
            <div>
              <strong>{{ areCoordinatesValid() ? 'Location Set Successfully' : 'School Location Required' }}</strong>
              <p class="mb-0">{{ getCoordinatesStatus() }}</p>
              <small class="text-muted" *ngIf="!areCoordinatesValid()">
                Click on the map below to set your exact school location
              </small>
            </div>
          </div>
        </div>

        <!-- School Logo Section -->
        <fieldset class="form-section mb-4">
          <legend>School Logo</legend>

          <div class="row g-4 align-items-center">
            <div class="col-12 col-md-6">
              <label class="form-label">Upload New Logo</label>
              <input type="file" 
                     class="form-control form-control-sm" 
                     accept="image/png,image/jpeg,image/jpg"
                     (change)="onFileSelected($event)">
              <div class="form-text text-muted small">Max 2MB • PNG, JPG, JPEG</div>
              <div class="text-danger small mt-1" *ngIf="logoError">{{ logoError }}</div>
            </div>

            <div class="col-12 col-md-6 text-center">
              <div class="avatar-large-preview mx-auto">
                <img [src]="logoPreview" 
                     alt="School Logo" 
                     class="logo-preview-img"
                     (error)="onLogoError($event)"
                     crossorigin="anonymous">
                <div class="initials-fallback">
                  {{ getSchoolInitials() }}
                </div>
              </div>
              <p class="mt-3 text-muted small">
                {{ logoPreview.includes('edglobe') ? 'Default Logo • Upload your own' : 'Current School Logo' }}
              </p>
            </div>
          </div>

          <div class="text-end mt-3">
            <button type="button" 
                    class="btn-material btn-primary" 
                    (click)="uploadLogo()"
                    [disabled]="!selectedFile || isUploadingLogo">
              <span *ngIf="isUploadingLogo" class="spinner-border spinner-border-sm me-2"></span>
              Upload Logo
            </button>
          </div>
        </fieldset>

        <!-- Basic Details -->
        <fieldset class="form-section mb-4">
          <legend>Basic Information</legend>
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">School Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control form-control-sm" formControlName="name">
              <div class="text-danger small" *ngIf="schoolForm.get('name')?.touched && schoolForm.get('name')?.errors?.['required']">
                School name is required
              </div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Contact Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control form-control-sm" formControlName="contact">
              <div class="text-danger small" *ngIf="schoolForm.get('contact')?.touched && schoolForm.get('contact')?.errors">
                Valid phone number required
              </div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Academic Year <span class="text-danger">*</span></label>
              <select class="form-select form-select-sm" formControlName="academicYear">
                <option value="">Select Year</option>
                <option *ngFor="let year of academicYear" [value]="year">{{ year }}</option>
              </select>
              <div class="text-danger small" *ngIf="schoolForm.get('academicYear')?.touched && schoolForm.get('academicYear')?.errors?.['required']">
                Academic year is required
              </div>
            </div>
          </div>
        </fieldset>

        <!-- Address -->
        <fieldset class="form-section mb-4">
          <legend>Address Details</legend>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Street Address <span class="text-danger">*</span></label>
              <input type="text" class="form-control form-control-sm" formControlName="street">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">City <span class="text-danger">*</span></label>
              <input type="text" class="form-control form-control-sm" formControlName="city">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">State</label>
              <input type="text" class="form-control form-control-sm" formControlName="state">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Postal Code</label>
              <input type="text" class="form-control form-control-sm" formControlName="postalCode">
            </div>
          </div>
        </fieldset>

        <!-- SCHOOL TIMING - ADDED & AUTO-FILLED -->
        <fieldset class="form-section mb-4">
          <legend>School Timing</legend>
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Opening Time</label>
              <input type="time" class="form-control form-control-sm" formControlName="openingTime">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Closing Time</label>
              <input type="time" class="form-control form-control-sm" formControlName="closingTime">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Lunch Break</label>
              <input type="text" class="form-control form-control-sm" formControlName="lunchBreak" 
                     placeholder="e.g. 12:30 - 13:10">
            </div>
          </div>
        </fieldset>

        <!-- Map -->
        <div class="form-section mb-4">
          <legend>Set School Location</legend>
          <div class="map-container">
            <google-map height="350px" width="100%" [center]="center" [zoom]="zoom" (mapClick)="onMapClick($event)">
              <map-marker *ngIf="markerPosition" [position]="markerPosition"></map-marker>
            </google-map>
          </div>
          <small class="text-muted d-block mt-2">
            Click on the map to set your exact school location
          </small>
        </div>

        <!-- Coordinates -->
        <div class="row g-3 mb-4">
          <div class="col-6">
            <label class="form-label">Latitude</label>
            <input type="text" class="form-control form-control-sm" formControlName="latitude" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Longitude</label>
            <input type="text" class="form-control form-control-sm" formControlName="longitude" readonly>
          </div>
        </div>

        <!-- Submit -->
        <div class="text-end">
          <button type="submit" 
                  class="btn-material btn-success px-5"
                  [disabled]="schoolForm.invalid || isSubmitting || !areCoordinatesValid()">
            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
            Update School
          </button>
        </div>
      </form>
    </div>
  </div>
</div>