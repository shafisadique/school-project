<div class="container">
  <div class="row">
    <div class="col-sm-12">
      <app-card>
        <div class="invoice-container">
          <form (ngSubmit)="generateInvoices()">
            <!-- Step 1: Select Class -->
            <fieldset class="form-section">
              <div class="row g-4">
                <div class="col-md-6 col-12">
                  <legend>Step 1: Select a Class</legend>
                  <div class="form-group">
                    <label>Class:</label>
                    <select class="form-control form-control-sm shadow-sm" [(ngModel)]="selectedClassId" (change)="updateClassSelection($event)" [ngModelOptions]="{standalone: true}">
                      <option value="" disabled>Select a class</option>
                      <option *ngFor="let cls of classList" [value]="cls.id">{{ cls.name }}</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6 col-12">
                  <legend>Step 2: Select Month</legend>
                  <div class="form-group">
                    <label>Month:</label>
                    <input type="month" class="form-control form-control-sm shadow-sm"
                           [(ngModel)]="month"
                           [ngModelOptions]="{standalone: true}"
                           [min]="minMonth"
                           [max]="maxMonth">
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-group">
                    <label class="checkbox-label">
                      <input type="checkbox" [(ngModel)]="isExamMonth" [ngModelOptions]="{standalone: true}">
                      Is this an exam month?
                    </label>
                  </div>
                </div>
              </div>
            </fieldset>

            <!-- Step 3: Set Payment Schedules and Miscalculation -->
            <fieldset class="form-section" *ngIf="students.length > 0">
              <legend>Step 3: Set Payment Schedules & Miscalculation</legend>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Student Name</th>
                      <th>Admission No</th>
                      <th>Payment Schedule</th>
                      <th>Custom Details</th>
                      <th>Apply Miscalculation Fee?</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let student of students; let i = index">
                      <td>{{ student.name }}</td>
                      <td>{{ student.admissionNo }}</td>
                      <td>
                        <select class="form-control form-control-sm shadow-sm"
                                [ngModel]="customSchedules[i]?.paymentSchedule"
                                (ngModelChange)="customSchedules[i].paymentSchedule = $event; updatePaymentSchedule(student._id, $event)"
                                [ngModelOptions]="{standalone: true}">
                          <option *ngFor="let option of paymentOptions" [value]="option">{{ option }}</option>
                        </select>
                      </td>
                      <td>
                        <input type="text" class="form-control form-control-sm shadow-sm"
                               [ngModel]="customSchedules[i]?.customPaymentDetails"
                               (ngModelChange)="customSchedules[i].customPaymentDetails = $event; updateCustomDetails(student._id, $event)"
                               [ngModelOptions]="{standalone: true}"
                               [disabled]="customSchedules[i]?.paymentSchedule !== 'Custom'"
                               placeholder="e.g., Paid for 2 months together">
                      </td>
                      <td>
                        <input type="checkbox" [(ngModel)]="miscalculationStudents[i]" [ngModelOptions]="{standalone: true}">
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </fieldset>

            <!-- Step 4: Generate Invoices -->
            <fieldset class="form-section text-center">
              <legend>Step {{ students.length > 0 ? 4 : 3 }}: Generate Invoices</legend>
              <button type="submit" class="btn btn-primary generate-btn" [disabled]="isGenerating">
                <span *ngIf="!isGenerating">
                  <i class="bi bi-file-earmark-check me-2"></i>Generate Invoices
                </span>
                <span *ngIf="isGenerating" class="spinner-border spinner-border-sm me-2" role="status"></span>
                <span *ngIf="isGenerating">Generating...</span>
              </button>
            </fieldset>
          </form>
        </div>
      </app-card>
    </div>
  </div>
</div>