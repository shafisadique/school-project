<div class="invoice-container">
  <!-- Header & Controls â€“ Your Original -->
  <div class="header-section">
    <h1 class="title">Invoice Management Dashboard</h1>
    <p class="subtitle">Manage and track invoices for students and classes efficiently.</p>
  </div>

  <div class="controls-section">
    <div class="toggle-group">
      <button class="toggle-btn" [ngClass]="{'active': viewMode === 'class'}" (click)="setViewMode('class')">
        Class View
      </button>
      <button class="toggle-btn" [ngClass]="{'active': viewMode === 'student'}" (click)="setViewMode('student')" [disabled]="!selectedClassId">
        Student View
      </button>
    </div>

    <div class="filter-group">
      <select class="form-select" [(ngModel)]="selectedClassId" (change)="updateClassSelection($event)" [disabled]="classList.length === 0">
        <option value="">Select Class</option>
        <option *ngFor="let classItem of classList" [value]="classItem.id">{{ classItem.name }}</option>
      </select>

      <select *ngIf="viewMode === 'student'" class="form-select" [(ngModel)]="selectedStudentId" (change)="updateStudentSelection($event)" [disabled]="!selectedClassId || studentData.length === 0">
        <option value="">Select Student</option>
        <option *ngFor="let student of studentData" [value]="student._id">{{ student.name }} ({{ student.admissionNo }})</option>
      </select>
      
      <input type="month" class="form-input" [(ngModel)]="month" (change)="loadInvoices()" [min]="minMonth" [max]="maxMonth" style="width: 100%;">

      <select class="form-select" [(ngModel)]="statusFilter" (change)="filterInvoices()">
        <option value="">All Statuses</option>
        <option value="Pending">Pending</option>
        <option value="Partial">Partial</option>
        <option value="Paid">Paid</option>
        <option value="Overdue">Overdue</option>
      </select>

      <button class="btn-notify" (click)="notifyParents()" [disabled]="!selectedClassId || !month">
        Notify Parents
      </button>
    </div>
  </div>

  <!-- Invoice Title -->
  <div class="invoice-title" *ngIf="selectedClassName && month">
    <h2>Invoices for {{ viewMode === 'class' ? selectedClassName : (selectedStudent?.name || 'Selected Student') }} - {{ month }}</h2>
  </div>

  <!-- ORIGINAL CLASS VIEW TABLE (Unchanged) -->
  <div class="table-wrapper" *ngIf="viewMode === 'class'">
    <table class="professional-table invoice-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Student</th>
          <th>Total Amount</th>
          <th>Remaining Due</th>
          <th>Status</th>
          <th>Due Date</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let invoice of filteredInvoices; let i = index">
          <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
          <td class="profile-cell">
            <div class="profile-wrapper">
              <div class="avatar-placeholder">{{ getInitials(invoice.studentId?.name || 'Unknown') }}</div>
              <span class="teacher-name">{{ invoice.studentId?.name || 'Unknown' }}</span>
            </div>
          </td>
          <td>{{ invoice.totalAmount | currency:'INR' }}</td>
          <td>{{ invoice.remainingDue | currency:'INR' }}</td>
          <td>
            <span class="badge" [ngClass]="{
              'bg-success': invoice.status === 'Paid',
              'bg-warning': invoice.status === 'Pending',
              'bg-info': invoice.status === 'Partial',
              'bg-danger': invoice.status === 'Overdue'
            }">
              {{ invoice.status }}
            </span>
          </td>
          <td>{{ invoice.dueDate | date:'dd-MMM-yyyy' }}</td>
          <td class="text-center">
            <button class="btn-material btn-outline-primary me-2" (click)="downloadInvoicePDF(invoice._id)">
              <i class="fas fa-download"></i> Download
            </button>
            <button *ngIf="invoice.status !== 'Paid'" class="btn-material btn-outline-success" (click)="processPayment(invoice._id, invoice.remainingDue)">
              <i class="fas fa-money-bill-wave"></i> Pay Now
            </button>
          </td>
        </tr>
        <tr *ngIf="filteredInvoices.length === 0 && selectedClassId && month">
          <td colspan="8" class="text-center no-data">No invoices found for the selected criteria.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- STUDENT VIEW LEDGER TABLE -->
  <div class="table-wrapper" *ngIf="viewMode === 'student'">
    <!-- Summary Card -->
    <div class="summary-card mb-3 p-3 bg-light rounded shadow-sm">
      <div class="row text-center">
        <div class="col-md-3">
          <h6 class="text-success">Total Paid</h6>
          <p class="h5">{{ summary.totalPaid | currency:'INR' }}</p>
        </div>
        <div class="col-md-3">
          <h6 class="text-danger">Total Due</h6>
          <p class="h5">{{ summary.totalDue | currency:'INR' }}</p>
        </div>
        <div class="col-md-3">
          <h6 class="text-info">Months Paid</h6>
          <p class="h5">{{ summary.monthsWithPayments }} / {{ summary.totalMonths }}</p>
        </div>
        <div class="col-md-3">
          <h6 class="text-muted">Overdue Months</h6>
          <p class="h5 text-warning">{{ (summary.overdueMonths || 0) }}</p>
        </div>
      </div>
    </div>

    <table class="table table-striped table-hover ledger-table">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Month</th>
          <th>Previous Dues</th>
          <th>Current Fee</th>
          <th>Total Amount</th>
          <th>Receipts (Paid)</th>
          <th>Remaining Due</th>
          <th>Status</th>
          <th>Due Date</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of filteredInvoices; let i = index" [ngClass]="getRowClass(row.status)">
          <td>{{ i + 1 }}</td>
          <td class="fw-bold text-primary">{{ row.month }}</td>
          <td class="text-end" [ngClass]="{ 'text-danger fw-bold': row.previousDue > 0 }">
            {{ row.previousDue | currency:'INR' }}
            <small *ngIf="row.previousDue > 0" class="d-block text-muted">Carry from last</small>
          </td>
          <td class="text-end">{{ row.currentFee | currency:'INR' }}</td>
          <td class="text-end fw-bold text-primary">{{ row.totalDues | currency:'INR' }}</td>
          <td class="text-end text-success">
            {{ row.paidAmount | currency:'INR' }}
            <small *ngIf="row.payments?.length > 0" class="d-block text-muted">({{ row.payments.length }} receipts)</small>
          </td>
          <td class="text-end fw-bold" [ngClass]="{ 'text-danger': row.remainingDue > 0 }">
            {{ row.remainingDue | currency:'INR' }}
          </td>
          <td>
            <span class="badge rounded-pill px-2 py-1" [ngClass]="getStatusClass(row.status)">
              {{ row.status }}
            </span>
          </td>
          <td class="text-muted">{{ row.dueDate | date:'dd-MMM-yyyy' }}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-primary me-1" (click)="downloadInvoicePDF(row._id)" title="Download PDF">
              <i class="fas fa-download"></i>
            </button>
            <button *ngIf="row.remainingDue > 0" class="btn btn-sm btn-outline-success me-1" (click)="processPayment(row._id, row.remainingDue)" title="Pay Now">
              <i class="fas fa-money-bill-wave"></i>
            </button>
            <button *ngIf="row.payments?.length > 0" class="btn btn-sm btn-outline-info" (click)="toggleRowExpansion(row._id)" title="View History">
              <i class="fas fa-history"></i> History
            </button>
          </td>
        </tr>

        <!-- Expandable Payment History -->
        <tr *ngFor="let row of filteredInvoices">
          <td *ngIf="expandedRows.has(row._id) && row.payments.length > 0" colspan="10">
            <div class="payment-history p-3 bg-light rounded border-start border-info">
              <h6 class="mb-2 text-info"><i class="fas fa-receipt me-1"></i>Payment History for {{ row.month }}</h6>
              <div class="table-responsive">
                <table class="table table-sm table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Date & Time</th>
                      <th>Amount</th>
                      <th>Method</th>
                      <th>Transaction ID</th>
                      <th>Processed By</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let payment of row.payments">
                      <td>{{ payment.date | date:'dd-MMM-yyyy HH:mm' }}</td>
                      <td class="text-success fw-bold">{{ payment.amount | currency:'INR' }}</td>
                      <td class="text-capitalize">{{ payment.method }}</td>
                      <td>{{ payment.transactionId || 'N/A' }}</td>
                      <td>{{ payment.processedBy || 'Admin' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <small class="text-muted mt-1 d-block">Total Paid: {{ row.paidAmount | currency:'INR' }} ({{ row.payments.length }} receipts)</small>
            </div>
          </td>
        </tr>

        <tr *ngIf="filteredInvoices.length === 0">
          <td colspan="10" class="text-center py-4">
            <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
            <p class="text-muted">No invoices found for this student.</p>
          </td>
        </tr>
      </tbody>
      <tfoot *ngIf="filteredInvoices.length > 0" class="table-light fw-bold">
        <tr>
          <th colspan="4" class="text-end">Grand Totals</th>
          <th>{{ summary.totalPaid | currency:'INR' }}</th>
          <th></th>
          <th class="text-danger">{{ summary.totalDue | currency:'INR' }}</th>
          <th colspan="3"></th>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Pagination -->
  <app-pagination *ngIf="filteredInvoices.length > 0" [currentPage]="currentPage" [pageSize]="pageSize" [totalItems]="totalItems" [pageSizeOptions]="pageSizeOptions" (pageChange)="onPageChange($event)" (pageSizeChange)="onPageSizeChange($event)">
  </app-pagination>
</div>