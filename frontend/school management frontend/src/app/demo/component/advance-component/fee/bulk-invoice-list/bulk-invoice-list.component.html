<div class="invoice-container">
  <!-- Header Section -->
  <div class="header-section">
    <h1 class="title">Invoice Management Dashboard</h1>
    <p class="subtitle">Manage and track invoices for students and classes efficiently.</p>
  </div>

  <!-- Toggle Switch and Filters -->
  <div class="controls-section">
    <div class="toggle-group">
      <button
        class="toggle-btn"
        [ngClass]="{'active': viewMode === 'class'}"
        (click)="setViewMode('class')">
        Class View
      </button>
      <button
        class="toggle-btn"
        [ngClass]="{'active': viewMode === 'student'}"
        (click)="setViewMode('student')"
        [disabled]="!selectedClassId">
        Student View
      </button>
    </div>

    <div class="filter-group">
      <select
        class="form-select"
        [(ngModel)]="selectedClassId"
        (change)="updateClassSelection($event)"
        [disabled]="classList.length === 0">
        <option value="">Select Class</option>
        <option *ngFor="let classItem of classList" [value]="classItem.id">{{ classItem.name }}</option>
      </select>

      <select
        *ngIf="viewMode === 'student'"
        class="form-select"
        [(ngModel)]="selectedStudentId"
        (change)="updateStudentSelection($event)"
        [disabled]="!selectedClassId || students.length === 0">
        <option value="">Select Student</option>
        <option *ngFor="let student of students" [value]="student._id">{{ student.name }} ({{ student.admissionNo }})</option>
      </select>

      <input
        type="month"
        class="form-input"
        [(ngModel)]="month"
        (change)="loadInvoices()"
        [min]="minMonth"
        [max]="maxMonth" style="width: 100%;">

      <select
        class="form-select"
        [(ngModel)]="statusFilter"
        (change)="filterInvoices()">
        <option value="">All Statuses</option>
        <option value="Pending">Pending</option>
        <option value="Partial">Partial</option>
        <option value="Paid">Paid</option>
        <option value="Overdue">Overdue</option>
      </select>

      <button
        class="btn-notify"
        (click)="notifyParents()"
        [disabled]="!selectedClassId || !month">
        Notify Parents
      </button>
    </div>
  </div>

  <!-- Invoice Title -->
  <div class="invoice-title" *ngIf="selectedClassName && month">
    <h2>Invoices for {{ viewMode === 'class' ? selectedClassName : (selectedStudent?.name || 'Selected Student') }} - {{ month }}</h2>
  </div>

<!-- Invoice Table -->
<div class="table-wrapper">
  <table class="professional-table invoice-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Student</th>
        <th>Total Amount</th>
        <th>Remaining Due</th>
        <th>Status</th>
        <th>Due Date</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let invoice of filteredInvoices; let i = index">
        <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
        <td class="profile-cell">
          <div class="profile-wrapper">
            <div class="avatar-placeholder">{{ getInitials(invoice.studentId?.name || 'Unknown') }}</div>
            <span class="teacher-name">{{ invoice.studentId?.name || 'Unknown' }}</span>
          </div>
        </td>
        <td>{{ invoice.totalAmount | currency:'INR' }}</td>
        <td>{{ invoice.remainingDue | currency:'INR' }}</td>
        <td>
          <span class="badge" [ngClass]="{
            'bg-success': invoice.status === 'Paid',
            'bg-warning': invoice.status === 'Pending',
            'bg-info': invoice.status === 'Partial',
            'bg-danger': invoice.status === 'Overdue'
          }">
            {{ invoice.status }}
          </span>
        </td>
        <td>{{ invoice.dueDate | date:'dd-MMM-yyyy' }}</td>
        <td class="text-center">
          <button class="btn-material btn-outline-primary me-2" (click)="downloadInvoicePDF(invoice._id)">
            <i class="fas fa-download"></i> Download
          </button>
          <button *ngIf="invoice.status !== 'Paid'" class="btn-material btn-outline-success" (click)="processPayment(invoice._id, invoice.remainingDue)">
            <i class="fas fa-money-bill-wave"></i> Pay Now
          </button>
        </td>
      </tr>
      <tr *ngIf="filteredInvoices.length === 0 && selectedClassId && month">
        <td colspan="7" class="text-center no-data">No invoices found for the selected criteria.</td>
      </tr>
    </tbody>
  </table>
</div>

  <!-- Pagination -->
  <app-pagination
    *ngIf="filteredInvoices.length > 0"
    [currentPage]="currentPage"
    [pageSize]="pageSize"
    [totalItems]="totalItems"
    [pageSizeOptions]="pageSizeOptions"
    (pageChange)="onPageChange($event)"
    (pageSizeChange)="onPageSizeChange($event)">
  </app-pagination>
</div>