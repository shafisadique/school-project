<div class="container-fluid">
  <header class="header">
    <h2>Result List</h2>
    <button (click)="navigateToCreateResult()" class="create-btn">Create Result</button>
  </header>

  <div class="filters">
    <div class="filter-group">
      <label for="academicYear">Academic Year</label>
      <select id="academicYear" [(ngModel)]="selectedAcademicYearId" (change)="onAcademicYearChange()" [disabled]="isLoadingAcademicYears">
        <option value="">Select Academic Year</option>
        <option *ngFor="let year of academicYears" [value]="year._id">{{ year.name }}</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="exam">Exam</label>
      <select id="exam" [(ngModel)]="selectedExamId" (change)="onExamChange()" [disabled]="isLoadingExams || !selectedAcademicYearId">
        <option value="">Select Exam</option>
        <option *ngFor="let exam of exams" [value]="exam._id">{{ getExamDisplayName(exam) }}</option>
      </select>
    </div>
  </div>

  <div class="result-table" *ngIf="!isLoadingResults; else loading">
    <table *ngIf="results.length > 0">
      <thead>
        <tr>
          <th>Student Name</th>
          <th>Roll No</th>
          <th>Exam</th>
          <th>Total Marks</th>
          <th>Percentage</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let result of results" [class.expanded]="expandedRows[result._id]">
          <td>{{ result.studentId.name || 'N/A' }}</td>
          <td>{{ result.studentId.rollNo || 'N/A' }}</td>
          <td>{{ result.examId.examTitle || 'N/A' }}</td>
          <td>{{ result.totalMarksObtained }} / {{ result.totalMaxMarks }}</td>
          <td>{{ result.percentage | number:'1.2-2' }}%</td>
          <td>{{ result.status }}</td>
          <td>
            <button (click)="toggleRow(result._id)">View Details</button>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="no-data" *ngIf="results.length === 0 && !isLoadingResults">
      No results found for the selected exam.
    </div>
  </div>

  <ng-template #loading>
    <div class="loading-overlay">Loading...</div>
  </ng-template>

  <div class="details" *ngFor="let result of results" [@expand]="expandedRows[result._id] ? 'expanded' : 'collapsed'">
    <h3>Subject Details for {{ result.studentId.name }}</h3>
    <table>
      <thead>
        <tr>
          <th>Subject</th>
          <th>Marks Obtained</th>
          <th>Max Marks</th>
          <th>Percentage</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let subject of result.subjects">
          <td>{{ subject.subjectId.name || 'N/A' }}</td>
          <td>{{ subject.marksObtained || 0 }}</td>
          <td>{{ subject.maxMarks || 0 }}</td>
          <td>{{ (subject.marksObtained / subject.maxMarks * 100) | number:'1.2-2' }}%</td>
        </tr>
        <!-- Fallback for partial results with subjectId -->
        <tr *ngIf="result.subjects.length === 0 && result.subjectId">
          <td>{{ result.subjectId.name || 'N/A' }}</td>
          <td>{{ result.marksObtained || 0 }}</td>
          <td>{{ 100 }}</td> <!-- Default max marks for partial results -->
          <td>{{ (result.marksObtained / 100 * 100) | number:'1.2-2' }}%</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>