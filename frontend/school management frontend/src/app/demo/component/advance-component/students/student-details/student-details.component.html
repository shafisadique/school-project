<div class="student-container">
  <!-- Header Section - Gradient Card with Title -->
  <div class="header-section">
    <div class="header-card">
      <h1 class="title">Student Management Dashboard</h1>
      <p class="subtitle">Manage student records, profiles, and portals efficiently.</p>
    </div>
  </div>

  <!-- Controls Section - Card with Flex/Grid Layout -->
  <div class="controls-section">
    <div class="controls-card">
      <!-- Left: Action Buttons (icons + labels, pill-shaped) -->
      <div class="buttons-group">
        <button 
          class="btn-material btn-primary" 
          (click)="createStudent()"
          aria-label="Create new student">
          <i class="fas fa-plus"></i> Create
        </button>
        <button 
          class="btn-material btn-secondary" 
          [disabled]="selectedStudents.length !== 1"
          (click)="onUpdateStudent()"
          aria-label="Update selected student">
          <i class="fas fa-pencil-alt"></i> Update
        </button>
        <button 
          class="btn-material btn-danger" 
          [disabled]="selectedStudents.length === 0"
          (click)="onDeleteStudents()"
          aria-label="Delete selected students">
          <i class="fas fa-trash"></i> Delete
        </button>
        <button 
          class="btn-material btn-success" 
          (click)="downloadExcel()"
          aria-label="Download students as Excel">
          <i class="fas fa-download"></i> Export
        </button>
      </div>

      <!-- Middle: Search with Icon -->
      <div class="search-group">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input 
            type="text" 
            class="form-control" 
            placeholder="Search by name or admission no..." 
            [(ngModel)]="searchQuery" 
            (input)="onSearchInputChange($event)"
            (keyup.enter)="onSearch()"
            role="search"
            [attr.aria-label]="'Search students'">
        </div>
      </div>
      
      <!-- Right: Filters (dropdowns + button) -->
      <div class="filters-group">
        <div class="filter-item">
          <select 
            class="form-select" 
            [(ngModel)]="selectedClass" 
            (change)="onFilterChange()"
            [attr.aria-label]="'Filter by class'">
            <option value="">All Classes</option>
            <option *ngFor="let classItem of classes" [value]="classItem._id">{{ classItem.name }}</option>
          </select>
          <i class="fas fa-graduation-cap filter-icon"></i>
        </div>

        <div class="filter-item">
          <select 
            class="form-select" 
            [(ngModel)]="selectedSession" 
            (change)="onFilterChange()"
            [attr.aria-label]="'Filter by session'">
            <option value="">All Sessions</option>
            <option *ngFor="let year of academicYears" [value]="year._id">{{ year.name }}</option>
          </select>
          <i class="fas fa-calendar-alt filter-icon"></i>
        </div>
        
        <button 
          class="btn-material btn-primary" 
          (click)="onSearch()"
          [attr.aria-label]="'Apply filters'">
          <i class="fas fa-filter"></i> Filter
        </button>
      </div>
    </div>
  </div>

  <!-- Table Section - Enhanced Professional Table -->
  <div class="table-section">
    <div class="table-card">
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm professional-table" role="table" aria-label="Students Table">
          <thead class="table-dark">
            <tr>
              <th scope="col" class="checkbox-col">
                <input 
                  type="checkbox" 
                  [checked]="areAllSelected()"
                  [indeterminate]="areSomeSelected()"
                  (change)="toggleAllSelection($event)"
                  [attr.aria-label]="'Select all students'">
              </th>
              <th scope="col" class="index-col">#</th>
              <th scope="col" class="name-col" (click)="onSort('name')" role="button" tabindex="0" [attr.aria-sort]="sortColumn === 'name' ? (sortDirection === 'asc' ? 'ascending' : 'descending') : 'none'">
                Student Name
                <i class="fas fa-sort ms-1" [ngClass]="{'fa-sort-up': sortColumn === 'name' && sortDirection === 'asc', 'fa-sort-down': sortColumn === 'name' && sortDirection === 'desc'}"></i>
              </th>
              <th scope="col" class="admission-col">Admission No</th>
              <th scope="col" class="class-col">Class</th>
              <th scope="col" class="gender-col">Gender</th>
              <th scope="col" class="status-col">Status</th>
              <th scope="col" class="actions-col text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let student of students; let i = index" [attr.data-student-id]="student._id" class="align-middle">
              <td class="checkbox-cell align-middle">
                <input 
                  type="checkbox"
                  [checked]="student.selected"
                  (change)="toggleStudentSelection(student, $event)"
                  [attr.aria-label]="'Select ' + student.name">
              </td>
              <td class="index-cell text-center">{{ (currentPage - 1) * pageSize + i + 1 }}</td>
              <td class="profile-cell align-middle" data-label="Student Name">
                <div class="profile-wrapper d-flex align-items-center">
                  <div class="avatar-placeholder me-2" [attr.aria-label]="'Avatar for ' + student.name">
                    <img
                      *ngIf="student.profileImage"
                      [src]="getImageUrl(student.profileImage)"
                      alt="{{ student.name }} profile"
                      class="profile-avatar"
                      crossorigin="anonymous"
                      (error)="onImageError($event)">
                    <span *ngIf="!student.profileImage">{{ getInitials(student.name) }}</span>
                  </div>
                  <div class="student-info flex-grow-1">
                    <div class="student-name fw-medium" [attr.title]="student.name">{{ student.name }}</div>
                  </div>
                </div>
              </td>
              <td class="admission-cell text-nowrap fw-semibold" data-label="Admission No" [attr.title]="student.admissionNo">{{ student.admissionNo }}</td>
              <td class="class-cell" data-label="Class" [attr.title]="student.classId?.name || 'N/A'">{{ student.classId?.name || 'N/A' }}</td>
              <td class="gender-cell text-center" data-label="Gender">
                <span class="badge badge-sm" [ngClass]="{'badge-primary': student.gender === 'Male', 'badge-secondary': student.gender === 'Female'}">
                  {{ student.gender }}
                </span>
              </td>
              <td class="status-cell text-center" data-label="Status">
                <span class="badge badge-sm" [ngClass]="{'badge-success': student.status, 'badge-warning': !student.status}">
                  {{ student.status ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td class="action-cell text-center align-middle" data-label="Actions">
                <div class="btn-group btn-group-sm" role="group">
                  <button 
                    class="btn btn-outline-info btn-sm" 
                    (click)="openStudentDetails(student, studentDetailsModal)"
                    [attr.aria-label]="'View details for ' + student.name"
                    title="View Details">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button 
                    class="btn btn-outline-secondary btn-sm" 
                    (click)="createPortal(student._id, 'student')"
                    [attr.aria-label]="'Create student portal for ' + student.name"
                    title="Student Portal">
                    <i class="fas fa-user-graduate"></i>
                  </button>
                  <button 
                    class="btn btn-outline-secondary btn-sm" 
                    (click)="createPortal(student._id, 'parent')"
                    [attr.aria-label]="'Create parent portal for ' + student.name"
                    title="Parent Portal">
                    <i class="fas fa-users"></i>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="students.length === 0" class="no-data-row">
              <td colspan="8" class="text-center py-4">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <p class="text-muted mb-0">No students found matching your criteria.</p>
                <small class="text-muted">Try adjusting filters or search terms.</small>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Pagination -->
  <div class="pagination-section">
    <app-pagination 
      [currentPage]="currentPage" 
      [pageSize]="pageSize" 
      [totalItems]="totalItems" 
      [pageSizeOptions]="pageSizeOptions" 
      (pageChange)="onPageChange($event)" 
      (pageSizeChange)="onPageSizeChange($event)"
      aria-label="Student pagination">
    </app-pagination>
  </div>
<!-- Student Details Modal - Simplified -->
<ng-template #studentDetailsModal let-modal>
  <div class="custom-modal-container">
    <div class="custom-modal-dialog">
      <div class="custom-modal">
        <!-- Header -->
        <div class="custom-modal-header">
          <h5 class="custom-modal-title">
            <i class="fas fa-user me-2"></i>Student Details: {{ selectedStudent?.name }}
          </h5>
          <button 
            type="button" 
            class="custom-modal-close" 
            aria-label="Close"
            (click)="modal.dismiss('Cross click')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <!-- Body -->
        <div class="custom-modal-body">
          <!-- Profile Avatar Section -->
          <div class="avatar-section">
            <div class="avatar-large">
              <img
                *ngIf="selectedStudent?.profileImage"
                [src]="getImageUrl(selectedStudent.profileImage)"
                alt="{{ selectedStudent?.name }}"
                crossorigin="anonymous"
                (error)="onImageError($event)"
                class="profile-avatar-large">
              <span *ngIf="!selectedStudent?.profileImage" class="initials-large">
                {{ getInitials(selectedStudent?.name || '') }}
              </span>
            </div>
            <h6 class="student-name">{{ selectedStudent?.name }}</h6>
            <div class="student-admission">{{ selectedStudent?.admissionNo }}</div>
          </div>

          <!-- Details Sections -->
          <div class="details-container">
            <!-- Personal Details -->
            <div class="details-section">
              <div class="section-title">
                <i class="fas fa-id-card me-2"></i>Personal Details
              </div>
              <div class="details-content">
                <div class="detail-row">
                  <span class="label">Date of Birth</span>
                  <span class="value">{{ selectedStudent?.dateOfBirth | date:'dd/MM/yyyy' }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Admission No</span>
                  <span class="value">{{ selectedStudent?.admissionNo }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Roll No</span>
                  <span class="value">{{ selectedStudent?.rollNo || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Gender</span>
                  <span class="value">
                    <span class="badge" [ngClass]="{'badge-primary': selectedStudent?.gender === 'Male', 'badge-secondary': selectedStudent?.gender === 'Female'}">
                      {{ selectedStudent?.gender }}
                    </span>
                  </span>
                </div>
                <div class="detail-row">
                  <span class="label">Address</span>
                  <span class="value">{{ selectedStudent?.address || 'N/A' }}</span>
                </div>
              </div>
            </div>

            <!-- Parents Section -->
            <div class="details-section">
              <div class="section-title">
                <i class="fas fa-users me-2"></i>Parent Details
              </div>
              <div class="details-content">
                <div class="detail-row">
                  <span class="label">Father</span>
                  <span class="value">{{ selectedStudent?.parents?.fatherName || 'N/A' }} ({{ selectedStudent?.parents?.fatherPhone || 'N/A' }})</span>
                </div>
                <div class="detail-row">
                  <span class="label">Mother</span>
                  <span class="value">{{ selectedStudent?.parents?.motherName || 'N/A' }} ({{ selectedStudent?.parents?.motherPhone || 'N/A' }})</span>
                </div>
              </div>
            </div>

            <!-- Portals Section -->
            <div class="details-section">
              <div class="section-title">
                <i class="fas fa-user-graduate me-2"></i>Student Portal
              </div>
              <div class="details-content">
                <div class="detail-row">
                  <span class="label">Username</span>
                  <span class="value">{{ selectedStudent?.portalUsername || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Password</span>
                  <span class="value">{{ selectedStudent?.portalPassword || 'N/A' }}</span>
                </div>
              </div>
            </div>

            <div class="details-section">
              <div class="section-title">
                <i class="fas fa-user-friends me-2"></i>Parent Portal
              </div>
              <div class="details-content">
                <div class="detail-row">
                  <span class="label">Username</span>
                  <span class="value">{{ selectedStudent?.parentPortalUsername || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Password</span>
                  <span class="value">{{ selectedStudent?.parentPortalPassword || 'N/A' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="custom-modal-footer">
          <button 
            type="button" 
            class="btn-close-modal" 
            (click)="modal.close('Close click')">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>