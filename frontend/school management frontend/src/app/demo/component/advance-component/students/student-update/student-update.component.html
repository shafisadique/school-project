<div class="container-fluid py-3 py-md-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10 col-xl-9">
      <app-card cardTitle="Update Student">

        <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
          <div class="row g-3">

            <!-- Personal Details -->
            <fieldset class="form-section">
              <legend>Personal Details</legend>

              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label">Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-sm" formControlName="name" placeholder="Full name">
                  <div class="text-danger small mt-1" *ngIf="submitted && f['name'].errors?.['required']">
                    Name is required
                  </div>
                  <div class="text-danger small mt-1" *ngIf="submitted && f['name'].errors?.['minlength']">
                    Minimum 2 characters
                  </div>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control form-control-sm" formControlName="email" placeholder="student@example.com">
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">Phone</label>
                  <input type="text" class="form-control form-control-sm" formControlName="phone" placeholder="10 digits">
                  <div class="text-danger small mt-1" *ngIf="submitted && f['phone'].errors?.['pattern']">
                    10 digits only
                  </div>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">Gender <span class="text-danger">*</span></label>
                  <select class="form-select form-select-sm" formControlName="gender">
                    <option value="">Select</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                  <div class="text-danger small mt-1" *ngIf="submitted && f['gender'].errors?.['required']">
                    Gender required
                  </div>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                  <input type="date" class="form-control form-control-sm" formControlName="dateOfBirth">
                  <div class="text-danger small mt-1" *ngIf="submitted && f['dateOfBirth'].errors?.['required']">
                    DOB required
                  </div>
                </div>

                <div class="col-12 col-md-3">
                  <label class="form-label">Class <span class="text-danger">*</span></label>
                  <select class="form-select form-select-sm" formControlName="classId">
                    <option value="">Select Class</option>
                    <option *ngFor="let c of classList" [value]="c._id">{{ c.name }}</option>
                    <option *ngIf="classList.length === 0" disabled>No classes available</option>
                  </select>
                  <div class="text-danger small mt-1" *ngIf="submitted && f['classId'].errors?.['required']">
                    Class required
                  </div>
                </div>

                <div class="col-12 col-md-3">
                  <label class="form-label">Section <span class="text-danger">*</span></label>
                  <select class="form-select form-select-sm" formControlName="section">
                    <option value="">Select Section</option>
                    <option *ngFor="let s of sectionList" [value]="s">{{ s }}</option>
                  </select>
                  <div class="text-danger small mt-1" *ngIf="submitted && f['section'].errors?.['required']">
                    Section required
                  </div>
                </div>

                <div class="col-12 col-md-3">
                  <label class="form-label">Status <span class="text-danger">*</span></label>
                  <select class="form-select form-select-sm" formControlName="status">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                  </select>
                  <div class="text-danger small mt-1" *ngIf="submitted && f['status'].errors?.['required']">
                    Status required
                  </div>
                </div>

                <div class="col-12 col-md-3">
                  <label class="form-label">Route</label>
                  <select class="form-select form-select-sm" formControlName="routeId" *ngIf="form.get('usesTransport')?.value">
                    <option value="">Select Route</option>
                    <option *ngFor="let r of routes" [value]="r._id">{{ r.name }}</option>
                  </select>
                  <div class="text-danger small mt-1" *ngIf="submitted && f['routeId']?.errors?.['required']">
                    Route required
                  </div>
                </div>
              </div>
            </fieldset>

            <!-- Facility Usage -->
            <fieldset class="form-section">
              <legend>Facility Usage</legend>

              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label">Transport</label>
                  <select class="form-select form-select-sm" formControlName="usesTransport">
                    <option [value]="false">No</option>
                    <option [value]="true">Yes</option>
                  </select>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">Hostel</label>
                  <select class="form-select form-select-sm" formControlName="usesHostel">
                    <option [value]="false">No</option>
                    <option [value]="true">Yes</option>
                  </select>
                </div>
              </div>
            </fieldset>

            <!-- Profile Picture -->
            <fieldset class="form-section">
              <legend>Profile Picture</legend>

              <div class="row g-3 align-items-center">
                <div class="col-12 col-md-6">
                  <label class="form-label">Upload New Profile Picture (Optional)</label>
                  <input type="file" class="form-control form-control-sm" accept="image/png,image/jpeg,image/jpg"
                         (change)="onFileSelect($event)">
                  <div class="text-danger small mt-1" *ngIf="fileError">{{ fileError }}</div>
                </div>

                <div class="col-12 col-md-6 text-center" *ngIf="imagePreview">
                  <img [src]="imagePreview" alt="Preview" class="img-thumbnail" style="max-height: 110px;">
                </div>
              </div>
            </fieldset>

            <!-- Address -->
            <fieldset class="form-section">
              <legend>Address</legend>

              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">Full Address <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-sm" formControlName="address" placeholder="House, Street, Area">
                  <div class="text-danger small mt-1" *ngIf="submitted && f['address'].errors?.['required']">
                    Address required
                  </div>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">City <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-sm" formControlName="city">
                  <div class="text-danger small mt-1" *ngIf="submitted && f['city'].errors?.['required']">
                    City required
                  </div>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">State <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-sm" formControlName="state">
                  <div class="text-danger small mt-1" *ngIf="submitted && f['state'].errors?.['required']">
                    State required
                  </div>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">Country <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-sm" formControlName="country">
                  <div class="text-danger small mt-1" *ngIf="submitted && f['country'].errors?.['required']">
                    Country required
                  </div>
                </div>
              </div>
            </fieldset>

            <!-- Parents' Details -->
            <fieldset class="form-section">
              <legend>Parents' Details</legend>

              <div class="alert alert-info small p-2" role="alert">
                At least one parent name and phone is required.
              </div>

              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label">Father's Name</label>
                  <input type="text" class="form-control form-control-sm" formControlName="fatherName">
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">Father's Phone</label>
                  <input type="text" class="form-control form-control-sm" formControlName="fatherPhone" placeholder="10 digits">
                  <div class="text-danger small mt-1" *ngIf="submitted && f['fatherName']?.value && !f['fatherPhone']?.value">
                    Phone required if name given
                  </div>
                  <div class="text-danger small mt-1" *ngIf="submitted && f['fatherPhone']?.errors?.['requiredIfName']">
                    Phone required if name given
                  </div>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">Mother's Name</label>
                  <input type="text" class="form-control form-control-sm" formControlName="motherName">
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">Mother's Phone</label>
                  <input type="text" class="form-control form-control-sm" formControlName="motherPhone" placeholder="10 digits">
                  <div class="text-danger small mt-1" *ngIf="submitted && f['motherName']?.value && !f['motherPhone']?.value">
                    Phone required if name given
                  </div>
                  <div class="text-danger small mt-1" *ngIf="submitted && f['motherPhone']?.errors?.['requiredIfName']">
                    Phone required if name given
                  </div>
                </div>
              </div>
            </fieldset>

                        <!-- APAAR ID (UDISE+ Compliance) -->
            <fieldset class="form-section mt-4">
              <legend>APAAR ID <small class="text-muted">(One Nation One Student ID)</small></legend>

              <div class="alert alert-info small p-2" role="alert">
                Update APAAR ID if generated later. Recommended for UDISE+ compliance.
              </div>

              <div class="row g-3">
                <div class="col-12 col-md-5">
                  <label class="form-label">APAAR ID</label>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    formControlName="apaarId"
                    placeholder="12-digit number"
                    maxlength="12"
                  >
                  <div class="text-danger small mt-1" *ngIf="submitted && f['apaarId'].errors?.['pattern']">
                    Must be exactly 12 digits
                  </div>
                  <small class="text-muted">Leave blank if not available</small>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">Status <span class="text-danger">*</span></label>
                  <select class="form-select form-select-sm" formControlName="apaarStatus">
                    <option *ngFor="let opt of apaarStatusOptions" [value]="opt.value">
                      {{ opt.label }}
                    </option>
                  </select>
                </div>

                <div class="col-12 col-md-3">
                  <label class="form-label">Notes (Optional)</label>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    formControlName="apaarNotes"
                    placeholder="e.g. Generated on Jan 2026"
                  >
                </div>
              </div>
            </fieldset>

            <!-- Server Error -->
            <div class="col-12" *ngIf="serverError">
              <div class="alert alert-danger small p-2">{{ serverError }}</div>
            </div>

            <!-- Submit -->
            <div class="col-12 d-flex justify-content-end gap-2">
              <button type="submit" class="btn btn-primary btn-sm" [disabled]="loading || form.invalid">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
                {{ loading ? 'Updating...' : 'Update Student' }}
              </button>
            </div>

          </div>
        </form>

      </app-card>
    </div>
  </div>
</div>