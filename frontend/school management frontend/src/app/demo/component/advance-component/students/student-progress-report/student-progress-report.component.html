<div class="container mt-4">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Submit Weekly Progress Reports</h5>
    </div>
    <div class="card-body">
      <form [formGroup]="reportForm" (ngSubmit)="onSubmit()">
        <div class="mb-3">
          <label for="classId" class="form-label">Select Class</label>
          <select id="classId" formControlName="classId" class="form-select" (change)="onClassChange($event)" [ngClass]="{ 'is-invalid': reportForm.get('classId')?.invalid && reportForm.get('classId')?.touched }">
            <option value="">Choose a class...</option>
            <option *ngFor="let classItem of classList" [value]="classItem._id">{{ classItem.name }}</option>
          </select>
          <div *ngIf="reportForm.get('classId')?.invalid && reportForm.get('classId')?.touched" class="invalid-feedback">Class is required</div>
        </div>

        <div *ngIf="students.length > 0" class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Admission No</th>
                <th>Grades</th>
                <th>Comments</th>
              </tr>
            </thead>
            <tbody formArrayName="studentProgress">
              <tr *ngFor="let student of students; let i = index" [formGroupName]="i">
                <td>{{ student.name }}</td>
                <td>{{ student.admissionNo }}</td>
                <td>
                  <input type="text" class="form-control" formControlName="grades" placeholder="e.g., Math: A, Science: B" [ngClass]="{ 'is-invalid': studentProgress.controls[i].get('grades')?.invalid && studentProgress.controls[i].get('grades')?.touched }">
                  <div *ngIf="studentProgress.controls[i].get('grades')?.invalid && studentProgress.controls[i].get('grades')?.touched" class="invalid-feedback">Valid grades are required (e.g., Math: A)</div>
                </td>
                <td>
                  <textarea class="form-control" formControlName="comments" rows="2" placeholder="Enter comments" [ngClass]="{ 'is-invalid': studentProgress.controls[i].get('comments')?.invalid && studentProgress.controls[i].get('comments')?.touched }"></textarea>
                  <div *ngIf="studentProgress.controls[i].get('comments')?.invalid && studentProgress.controls[i].get('comments')?.touched" class="invalid-feedback">Comments are required (max 160 characters)</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-3" [disabled]="reportForm.invalid || loading || students.length === 0">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
          {{ loading ? 'Saving...' : 'Save All Reports' }}
        </button>
      </form>
    </div>
  </div>
</div>