<div *ngIf="isAdmin">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12 col-md-3 col-lg-3">
        <div class="custom-card" >
          <div class="card-content">
            <div class="text-group">
              <h2 style="color: #007BFF;">{{totalStudent}}</h2>
              <p style="color: #007BFF;">Students</p>
            </div>
            <div class="icon"><img src="https://img.icons8.com/ios-filled/50/007BFF/graduation-cap.png" alt="Students Icon" width="40"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3 col-lg-3">
        <div class="custom-card" >
          <div class="card-content">
            <div class="text-group">
              <h2 style="color: #007BFF;">{{totalTeacher}}</h2>
              <p style="color: #007BFF;">Teachers</p>
            </div>
            <div class="icon"><img src="https://img.icons8.com/ios-filled/50/007BFF/conference-call.png" alt="Teachers Icon" width="40"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3 col-lg-3">
        <div class="custom-card" >
          <div class="card-content">
            <div class="text-group">
              <h2 style="color: #dc3545;">{{overallDue}}</h2>
              <p>Over All Due</p>
            </div>
            <div class="icon"><img src="https://img.icons8.com/?size=100&id=39952&format=png&color=007BFF" alt="Private Teachers Icon" width="40"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3 col-lg-3">
        <div class="custom-card" >
          <div class="card-content">
            <div class="text-group">
              <h2 style="color: #198754;">{{overallPaid}}</h2>
              <p style="color: #007BFF;">Paid</p>
            </div>
            <div class="icon"><img src="https://img.icons8.com/?size=100&id=39952&format=png&color=007BFF" alt="Private Teachers Icon" width="40"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-7 col-sm-12" >
        <div class="chart-card">
          <div class="manage-value">
            <h4 class="chart-title">Management Value</h4>
            <div class="chart-filters">
              <button class="btn-fill blue" (click)="onPeriodChange('weekly')">Weekly</button>
              <button class="btn-fill orange" (click)="onPeriodChange('monthly')">Monthly</button>
              <button class="btn-fill purple" (click)="onPeriodChange('yearly')">Yearly</button>
            </div>
          </div>
          <apx-chart
            #managementChart
            [series]="managementChartOptions.series"
            [chart]="managementChartOptions.chart"
            [stroke]="managementChartOptions.stroke"
            [dataLabels]="managementChartOptions.dataLabels"
            [markers]="managementChartOptions.markers"
            [xaxis]="managementChartOptions.xaxis"
            [yaxis]="managementChartOptions.yaxis"
            [grid]="managementChartOptions.grid"
            [fill]="managementChartOptions.fill"
            [theme]="managementChartOptions.theme"
            [legend]="managementChartOptions.legend"
            [tooltip]="managementChartOptions.tooltip"
          ></apx-chart>
          <div *ngIf="!managementChartOptions.series?.length" class="text-center" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;">No data available</div>
        </div>
      </div>
      <div class="col-md-5 col-lg-5 col-sm-12">
        <div class="chart-card col-md-8 col-sm-12" style="width: 100%;">
          <h4 class="chart-title" style="text-align: center;">Filter For Student and Fee Reports</h4>
          <div class="col-md-12 mb-3">
            <div class="row">
              <div class="col-12">
                <div class="form-group mb-3">
                  <select id="monthSelect"
                          [(ngModel)]="selectedMonth"
                          (change)="onFilterChange()"
                          class="form-select form-select-sm custom-dropdown">
                    <option value="">-- Select Month --</option>
                    <ng-container *ngFor="let month of getMonthsForYear()">
                      <option [value]="month.value">
                        {{ month.label }} {{ month.value.split('-')[0] }}
                      </option>
                    </ng-container>
                  </select>
                </div>
              </div>
              <div class="col-12">
                <div class="form-group mb-3">
                  <select [(ngModel)]="selectedClassId" (change)="onClassChange($event)" class="form-select form-select-sm custom-dropdown">
                    <option value="">All Classes</option>
                    <ng-container *ngFor="let class of classes">
                      <option [value]="class._id">{{ class.name || 'Unknown' }}</option>
                    </ng-container>
                  </select>
                </div>
              </div>
              <div class="col-12">
                <div class="form-group mb-3">
                  <select [(ngModel)]="selectedAcademicYearId" (change)="onFilterChange()" class="form-select form-select-sm custom-dropdown">
                    <option value="">Select Academic Year</option>
                    <ng-container *ngFor="let year of academicYears">
                      <option [value]="year._id">{{ year.name }}</option>
                    </ng-container>
                  </select>
                </div>
              </div>
              <div class="col-md-12">
                <button class="btn btn-success shadow-lg" (click)="exportDefaultersExcel()" style="border-radius: 5px;">Export Data</button>
              </div>
            </div>
          </div>
          <div class="student">
            <h5 style="font-family: 'Poppins',sans-serif;font-size: 14px;color: gray; font-weight: 400;">Total Student Present: {{ studentPresent }}</h5>
            <h5 style="font-family: 'Poppins',sans-serif;font-size: 14px;color: gray; font-weight: 400;">Total Student Absent: {{ studentAbsent }}</h5>
          </div>
          <div class="teacher">
            <h5 style="font-family: 'Poppins',sans-serif;font-size: 14px;color: gray; font-weight: 400;">Total Teacher Present: {{ teacherPresent }}</h5>
            <h5 style="font-family: 'Poppins',sans-serif;font-size: 14px;color: gray; font-weight: 400;">Total Teacher Absent: {{ teacherAbsent }}</h5>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top: 10px; margin-bottom: 10px;">
      <div class="col-12 col-md-3 col-lg-3">
        <div class="custom-card" >
          <div class="card-content">
            <div class="text-group">   
              <h2 style="color: #007BFF;">₹{{ summary.totalRemainingDue | number }}</h2>
              <p style="color: #007BFF;">Total Remaining Due</p>
            </div>
            <div class="icon"><img src="https://img.icons8.com/ios-filled/50/007BFF/graduation-cap.png" alt="Students Icon" width="40"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3 col-lg-3">
        <div class="custom-card" >
          <div class="card-content">
            <div class="text-group">
              <h2 style="color: #007BFF;">₹{{ summary.totalPaid | number }}</h2>
              <p style="color: #007BFF;">Total Paid</p>
            </div>
            <div class="icon"><img src="https://img.icons8.com/ios-filled/50/007BFF/conference-call.png" alt="Teachers Icon" width="40"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3 col-lg-3">
        <div class="custom-card" >
          <div class="card-content">
            <div class="text-group">
              <h2 style="color: #007BFF;">{{ summary.overdueCount }}</h2>
              <p style="color: #007BFF;">Overdue Invoices</p>
            </div>
            <div class="icon"><img src="https://img.icons8.com/?size=100&id=39952&format=png&color=007BFF" alt="Private Teachers Icon" width="40"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3 col-lg-3">
        <div class="custom-card" >
          <div class="card-content">
            <div class="text-group">
              
              <h2 style="color: #007BFF;">{{ summary.collectionRate }}%</h2>
              <p style="color: #007BFF;">Collection Rate</p>
            </div>
            <div class="icon"><img src="https://img.icons8.com/?size=100&id=39952&format=png&color=007BFF" alt="Private Teachers Icon" width="40"></div>
          </div>
        </div>
      </div>
    </div>


    <!-- Tables in One Row -->
    <div class="row">
      <div class="col-md-7 col-sm-12 col-lg-7">
        <div class="card custom-table-card shadow-sm">
          <div class="card-header bg-gradient text-white p-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Class-wise Fee Breakdown</h5>
           
          </div>
          <div class="table-responsive">
            <table class="table table-hover custom-table align-middle table-bordered">
              <thead class="table-light">
                <tr>
                  <th (click)="sortTable('className', 'breakdownByClass')">Class</th>
                  <th (click)="sortTable('invoiceCount', 'breakdownByClass')">Invoices</th>
                  <th (click)="sortTable('totalAmount', 'breakdownByClass')">Total Amount (₹)</th>
                  <th (click)="sortTable('totalPaid', 'breakdownByClass')">Paid Amount (₹)</th>
                  <th (click)="sortTable('totalRemainingDue', 'breakdownByClass')">Remaining Due (₹)</th>
                  <th (click)="sortTable('overdueCount', 'breakdownByClass')">Overdue</th>
                  <th (click)="sortTable('collectionRate', 'breakdownByClass')">Collection Rate</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngIf="breakdownByClass.length; else noBreakdownData">
                  <tr *ngFor="let classData of breakdownByClass | orderBy: sortColumn:sortDirection">
                    <td>{{ classData.className || 'Unknown' }}</td>
                    <td>{{ classData.invoiceCount }}</td>
                    <td>₹{{ classData.totalAmount | number }}</td>
                    <td class="text-success fw-semibold">₹{{ classData.totalPaid | number }}</td>
                    <td>
                      <span [ngClass]="classData.totalRemainingDue > 0 ? 'badge bg-danger' : 'badge bg-success'">
                        ₹{{ classData.totalRemainingDue | number }}
                      </span>
                    </td>
                    <td>{{ classData.overdueCount }}</td>
                    <td>
                      <div class="progress" style="height: 18px;">
                        <div class="progress-bar bg-success fw-semibold"
                            [style.width]="classData.collectionRate + '%'"
                            role="progressbar"
                            [attr.aria-valuenow]="classData.collectionRate"
                            aria-valuemin="0" aria-valuemax="100">
                          {{ classData.collectionRate | number:'1.0-0' }}%
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
                <ng-template #noBreakdownData>
                  <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                      No fee data available for the selected filters
                    </td>
                  </tr>
                </ng-template>
              </tbody>
            </table>
          </div>
        </div>
        <div class="chart-card">
            <h5 class="mb-3">Payment Method & Monthly Trend (Last 6 Months)</h5>
            <!-- <div style="display: flex;"> -->
          <div class="row">
            <div class="col-md-6 col-md-12">
              <apx-chart
                #paymentMethodChart
                [series]="paymentMethodChartOptions?.series || [1]"
                [chart]="paymentMethodChartOptions?.chart"
                [labels]="paymentMethodChartOptions?.labels"
                [colors]="paymentMethodChartOptions?.colors"
                [legend]="paymentMethodChartOptions?.legend"
                [responsive]="paymentMethodChartOptions?.responsive"
                [fill]="paymentMethodChartOptions?.fill"
                [dataLabels]="paymentMethodChartOptions?.dataLabels"
                [plotOptions]="paymentMethodChartOptions?.plotOptions"
              ></apx-chart>
            </div>
            <div class="col-md-6 col-md-12">
              <apx-chart
                #monthlyTrendChart
                [series]="monthlyTrendChartOptions?.series || []"
                [chart]="monthlyTrendChartOptions?.chart"
                [xaxis]="monthlyTrendChartOptions?.xaxis"
                [colors]="monthlyTrendChartOptions?.colors"
                [legend]="monthlyTrendChartOptions?.legend"
                [responsive]="monthlyTrendChartOptions?.responsive"
                [stroke]="monthlyTrendChartOptions?.stroke"
                [fill]="monthlyTrendChartOptions?.fill" 
                [markers]="monthlyTrendChartOptions?.markers"
              ></apx-chart>
            </div>
          </div>
            
              <div *ngIf="!monthlyTrend.length" class="text-center">No trend data available</div>
          <!-- </div> -->

        </div>
      </div>

      <!-- Top Defaulters (Updated Design) -->
      <!-- Top Defaulters - SIMPLE & FAST (No Virtual Scroll) -->
<div class="col-md-5 col-sm-12">
  <div class="card custom-table-card shadow-sm">
    <div class="card-header bg-gradient text-white p-3 d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        Top Defaulters 
        <small class="text-light">
          ({{ topDefaulters.length }} of {{ totalDefaultersCount || topDefaulters.length }})
        </small>
      </h5>
      <button class="btn btn-sm btn-light" (click)="viewAllDefaulters()">
        View All
      </button>
    </div>

    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
      <table class="table table-hover mb-0">
        <thead class="table-light sticky-top">
          <tr>
            <th>Name</th>
            <th>Admission No.</th>
            <th>Class</th>
            <th>Due (₹)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of topDefaulters">
            <td>{{ d.studentName }}</td>
            <td>{{ d.admissionNo }}</td>
            <td>{{ d.className }}</td>
            <td class="text-danger fw-bold">₹{{ d.remainingDue | number }}</td>
          </tr>
          <tr *ngIf="topDefaulters.length === 0">
            <td colspan="4" class="text-center py-4 text-muted">No defaulters found</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="p-3 border-top bg-light d-flex flex-wrap gap-2 justify-content-center">
  <button 
    class="btn btn-sm btn-warning px-4" 
    (click)="sendSMSReminders()"
    [disabled]="totalDefaultersCount === 0">
    <i class="fas fa-sms me-1"></i>
    Send SMS Reminder
    <span *ngIf="totalDefaultersCount > 0" class="badge bg-danger ms-1">
      {{ totalDefaultersCount }}
    </span>
  </button>

  <button 
    class="btn btn-sm btn-success px-4" 
    (click)="generateReceipts()"
    [disabled]="totalDefaultersCount === 0">
    <i class="fas fa-file-pdf me-1"></i>
    Generate Receipts (ZIP)
  </button>

  <button 
    class="btn btn-sm btn-info text-white px-4" 
    (click)="exportDefaultersExcel()"
    [disabled]="totalDefaultersCount === 0">
    <i class="fas fa-file-excel me-1"></i>
    Export Excel
  </button>
</div>
  </div>
</div>
    </div>
  </div>
</div>